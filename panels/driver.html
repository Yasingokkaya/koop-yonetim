<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Süt Toplama Rota</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; padding-bottom: 90px; }
        
        /* CANLI HEADER TASARIMI */
        .header-card {
            background: linear-gradient(135deg, #0f766e 0%, #0e7490 100%); /* Turkuaz/Mavi Geçiş */
            color: white; 
            padding: 20px 20px 30px 20px;
            border-bottom-left-radius: 30px; 
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 25px rgba(14, 116, 144, 0.3);
            position: relative;
            margin-bottom: 40px;
        }

        /* İSTATİSTİK KUTULARI */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
            margin-top: 20px;
        }
        .stat-box {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px; padding: 10px 5px;
            text-align: center; backdrop-filter: blur(5px);
        }
        .stat-val { font-size: 1.4rem; font-weight: 800; line-height: 1.2; }
        .stat-label { font-size: 0.75rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }

        /* ÇIKIŞ BUTONU */
        .logout-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; cursor: pointer;
        }
        .logout-btn:active { transform: scale(0.9); background: rgba(255,0,0,0.4); }
        .date-picker-custom {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; border-radius: 10px; padding: 5px 10px; width: 100%; text-align: center;
        }
        .input-card {
            background: white; border-radius: 20px; padding: 25px;
            margin: -20px 15px 15px 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative;
        }
        .form-select-lg, .form-control-lg { border-radius: 12px; border: 2px solid #e2e8f0; padding: 12px; font-size: 1.1rem; }
        .btn-collect {
            background: linear-gradient(45deg, #22c55e, #16a34a); color: white; font-weight: bold; font-size: 1.2rem;
            padding: 14px; border-radius: 12px; width: 100%; border: none; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }
        .record-item { background: white; margin: 10px 15px; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 5px solid; }
        .border-sabah { border-color: #f59e0b; } 
        .border-aksam { border-color: #3b82f6; }
        /* YENİ EKLENECEK STİL: SANAL KLAVYE */
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 Yan yana */
            gap: 8px;
            margin-bottom: 20px;
        }
        .numpad-grid button {
            padding: 15px 0;
            font-size: 1.8rem; /* Büyük rakamlar */
            border-radius: 12px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            color: #1e293b;
            font-weight: 700;
            box-shadow: 0 2px 0 #cbd5e1;
            transition: 0.1s;
        }
        .numpad-grid button:active {
            transform: scale(0.95);
            background-color: #f1f5f9;
            box-shadow: none;
        }
        /* LİSTE İKONLARI İÇİN RENKLİ KUTULAR */
        .icon-box {
            width: 45px; height: 45px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; margin-right: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .sabah-bg { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; } /* Turuncu Tonları */
        .aksam-bg { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; } /* Mavi Tonları */
        
        /* BUTON GRUBU */
        .action-btns button {
            width: 38px; height: 38px; border-radius: 10px; border: none;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-edit-rec { background: #e0f2fe; color: #0284c7; margin-right: 5px; }
        .btn-del-rec { background: #fee2e2; color: #dc2626; }
        .btn-edit-rec:active, .btn-del-rec:active { transform: scale(0.90); }
    </style>
</head>
<body>

<div class="header-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <div class="bg-white text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                <i class="fa-solid fa-truck-fast fa-lg"></i>
            </div>
            <div>
                <h5 class="m-0 fw-bold">Süt Toplama</h5>
                <small class="opacity-75" id="driverName">Yükleniyor...</small>
            </div>
        </div>
        <button class="logout-btn" id="logoutBtn" onclick="cikisYap()">
            <i class="fa-solid fa-right-from-bracket"></i>
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-val text-warning" id="totalSabah">0</div>
            <div class="stat-label">Sabah</div>
        </div>
        <div class="stat-box">
            <div class="stat-val text-info" id="totalAksam">0</div>
            <div class="stat-label">Akşam</div>
        </div>
        <div class="stat-box" style="background: white; color: #0e7490;">
            <div class="stat-val" id="dailyTotal">0</div>
            <div class="stat-label fw-bold">Toplam</div>
        </div>
    </div>

    <div class="mt-4">
        <div class="row g-2 align-items-center">
            <div class="col-5">
                <input type="date" class="form-control border-0 shadow-sm text-center fw-bold" 
                       style="background: rgba(255,255,255,0.9); height: 45px; border-radius: 12px;" 
                       id="islemTarihi">
            </div>
            <div class="col-7">
                <div class="d-flex gap-2 bg-white p-1 rounded-4 shadow-sm">
                    <button type="button" class="btn btn-sm flex-grow-1 fw-bold rounded-3" id="btnAksam"
                            style="color: #64748b;" onclick="setPeriod('aksam')">
                        <i class="fa-solid fa-moon"></i> Akşam
                    </button>
                    <button type="button" class="btn btn-sm flex-grow-1 fw-bold rounded-3 active-mode" id="btnSabah"
                            style="background: #fff7ed; color: #ea580c; border: 1px solid #fed7aa;" onclick="setPeriod('sabah')">
                        <i class="fa-solid fa-sun"></i> Sabah
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="input-card">
    <form id="collectionForm">
        <div class="mb-3">
            <label class="form-label text-muted small fw-bold">Rota / Köy Seç</label>
            <select class="form-select" id="villageFilter">
                <option value="all">Tüm Rotalar</option>
                <option value="Merkez">Merkez</option>
                <option value="Cevizlik">Cevizlik</option>
                <option value="Kınık">Kınık</option>
                <option value="Diğer">Diğer</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label text-muted small fw-bold">Üretici / Cari (Sıralı)</label>
            <select class="form-select form-select-lg fw-bold text-dark" id="memberSelect" required>
                <option value="">Önce rota seçiniz...</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label class="form-label text-muted small fw-bold">Süt Miktarı (Lt)</label>
            <input type="tel" class="form-control form-control-lg fw-bold text-center bg-white fs-1 text-primary" id="literInput" placeholder="0" readonly>
        </div>

        <div class="numpad-grid">
            <button type="button" onclick="addNum('1')">1</button>
            <button type="button" onclick="addNum('2')">2</button>
            <button type="button" onclick="addNum('3')">3</button>
            
            <button type="button" onclick="addNum('4')">4</button>
            <button type="button" onclick="addNum('5')">5</button>
            <button type="button" onclick="addNum('6')">6</button>
            
            <button type="button" onclick="addNum('7')">7</button>
            <button type="button" onclick="addNum('8')">8</button>
            <button type="button" onclick="addNum('9')">9</button>
            
            <button type="button" class="text-danger" onclick="clearNum()">C</button>
            <button type="button" onclick="addNum('0')">0</button>
            <button type="button" class="text-secondary" onclick="delNum()"><i class="fa-solid fa-delete-left"></i></button>
        </div>

        <button type="submit" class="btn btn-collect"><i class="fa-solid fa-save me-2"></i> KAYDET</button>
    </form>
</div>

<h6 class="ms-3 text-secondary fw-bold small">BU TARİHTEKİ İŞLEMLER</h6>
<div id="recordsList" class="pb-4"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { auth, db, signOut, onAuthStateChanged, collection, addDoc, query, where, onSnapshot, getDoc, doc, deleteDoc, updateDoc } from "../js/firebase-config.js";

   let currentCoopId = null;
    let currentDriverId = null;
    let currentPeriod = "sabah";
    let allMembersData = [];
    let todayRecords = []; // YENİ: Bugün süt verenleri burada tutacağız

    // Sayfa açılınca bugünün tarihini seçili yap
    document.getElementById('islemTarihi').valueAsDate = new Date();

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentDriverId = user.uid;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if(userDoc.exists()) {
                currentCoopId = userDoc.data().coopId;
                document.getElementById("driverName").innerText = userDoc.data().adSoyad;
                uyeleriHafizayaAl();
                kayitlariDinle(); // Seçili tarihe göre dinler
            }
        } else { window.location.href = "../index.html"; }
    });

    // TARİH DEĞİŞİNCE LİSTEYİ YENİLE
    document.getElementById("islemTarihi").addEventListener("change", kayitlariDinle);

    function uyeleriHafizayaAl() {
        const q = query(collection(db, "members"), where("coopId", "==", currentCoopId));
        onSnapshot(q, (snapshot) => {
            allMembersData = [];
            snapshot.forEach((doc) => {
                let data = doc.data();
                data.id = doc.id;
                allMembersData.push(data);
            });
            dropdownDoldur("all");
        });
    }

    document.getElementById("villageFilter").addEventListener("change", function() { dropdownDoldur(this.value); });

    function dropdownDoldur(selectedVillage) {
        const selectBox = document.getElementById("memberSelect");
        selectBox.innerHTML = '<option value="">Sıradaki...</option>';

        // 1. Köye göre filtrele
        let filtered = (selectedVillage === "all") ? allMembersData : allMembersData.filter(m => m.koy === selectedVillage);

        // 2. YENİ: Zaten süt vermişse listeden çıkar!
        // Mantık: Şu anki periyotta (sabah/akşam) bu üye ID'sine ait bir kayıt var mı?
        filtered = filtered.filter(uye => {
            // Bu üyenin bugünkü kayıtlar içinde, şu anki periyotta (örn: sabah) kaydı var mı?
            const zatenVerdi = todayRecords.some(rec => rec.memberId === uye.id && rec.period === currentPeriod);
            return !zatenVerdi; // Eğer verdi ise false döndür (listeden at), vermedi ise true (listede tut)
        });

        // 3. Sıralama (1, 2, 3...)
        filtered.sort((a,b) => (Number(a.sira) || 999) - (Number(b.sira) || 999));

        if(filtered.length === 0) {
             const option = document.createElement("option");
             option.text = "--- Bu rotada işlem tamam ---";
             selectBox.appendChild(option);
        } else {
            filtered.forEach(uye => {
                const option = document.createElement("option");
                option.value = uye.id;
                option.text = `${uye.sira || '-'} - ${uye.ad} ${uye.soyad}`;
                selectBox.appendChild(option);
            });
            // Otomatik 1. sıradakini seç
            if(selectedVillage !== "all") selectBox.selectedIndex = 1;
        }
    }

    window.setPeriod = function(p) {
        currentPeriod = p;
        
        // Buton Stilleri (Aktif olan renkli, pasif olan sönük)
        const btnS = document.getElementById("btnSabah");
        const btnA = document.getElementById("btnAksam");
        
        if(p === 'sabah') {
            // Sabah Aktif (Turuncu)
            btnS.style = "background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; font-weight: bold;";
            btnS.className = "btn btn-sm flex-grow-1 active";
            
            // Akşam Pasif
            btnA.style = "background: transparent; color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.3);";
            btnA.className = "btn btn-sm flex-grow-1";
        } else {
            // Akşam Aktif (Mavi)
            btnA.style = "background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; font-weight: bold;";
            btnA.className = "btn btn-sm flex-grow-1 active";
            
            // Sabah Pasif
            btnS.style = "background: transparent; color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.3);";
            btnS.className = "btn btn-sm flex-grow-1";
        }

        // Listeyi periyoda göre yeniden hesapla (Sabah verenler akşam listesinde görünsün diye)
        const seciliKoy = document.getElementById("villageFilter").value;
        dropdownDoldur(seciliKoy);
    }

    // --- SANAL KLAVYE KODLARI ---
    window.addNum = function(num) {
        const inp = document.getElementById("literInput");
        // Eğer 0 ise sil, yanına yaz (Çift sıfır olmasın)
        if(inp.value === "0") inp.value = "";
        inp.value += num;
    }

    window.delNum = function() {
        const inp = document.getElementById("literInput");
        inp.value = inp.value.slice(0, -1); // Son karakteri sil
    }

    window.clearNum = function() {
        document.getElementById("literInput").value = "";
    }

    document.getElementById("collectionForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const memId = document.getElementById("memberSelect").value;
        const memName = document.getElementById("memberSelect").options[document.getElementById("memberSelect").selectedIndex].text;
        const liters = Number(document.getElementById("literInput").value);
        
        
        

       // SEÇİLİ TARİHİ AL
        const seciliTarihStr = document.getElementById("islemTarihi").value; 
        const dateParts = seciliTarihStr.split("-");
        const formattedDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;

        // SAAT AYARI: Seçilen tarih ile şu anki saati birleştir
        const suAn = new Date();
        const tamTarih = new Date(seciliTarihStr);
        tamTarih.setHours(suAn.getHours(), suAn.getMinutes(), suAn.getSeconds());

        if(!memId || liters <= 0) { Swal.fire("Eksik", "Bilgileri kontrol et", "warning"); return; }

        try {
            await addDoc(collection(db, "milk_records"), {
                memberId: memId,
                memberName: memName,
                liters: liters,
                period: currentPeriod,
                date: tamTarih,        // Artık saati de içeriyor
                dateString: formattedDate,
                driverId: currentDriverId,
                coopId: currentCoopId
            });
            document.getElementById("literInput").value = "";
            const Toast = Swal.mixin({toast: true, position: 'top', showConfirmButton: false, timer: 1000});
            Toast.fire({ icon: 'success', title: 'Kaydedildi' });
        } catch (error) { Swal.fire("Hata", error.message, "error"); }
    });

    function kayitlariDinle() {
        const rawDate = document.getElementById("islemTarihi").value;
        const parts = rawDate.split("-");
        const targetDateStr = `${parts[2]}.${parts[1]}.${parts[0]}`;

        const q = query(
            collection(db, "milk_records"), 
            where("coopId", "==", currentCoopId),
            where("dateString", "==", targetDateStr)
        );
onSnapshot(q, (snapshot) => {
            const listDiv = document.getElementById("recordsList");
            listDiv.innerHTML = "";
            
            // Sayaçları Sıfırla
            let totalGenel = 0;
            let totalSabah = 0;
            let totalAksam = 0;
            
            let records = [];
            todayRecords = []; 

            snapshot.forEach(doc => { 
                let d = doc.data(); 
                d.id = doc.id; 
                records.push(d); 
                
                // İstatistikleri Hesapla
                const miktar = Number(d.liters);
                totalGenel += miktar;
                
                if(d.period === 'sabah') totalSabah += miktar;
                else totalAksam += miktar;

                todayRecords.push(d);
            });

            // Listeyi Yenile
            const seciliKoy = document.getElementById("villageFilter").value;
            dropdownDoldur(seciliKoy);

            // EKRANDAKİ SAYAÇLARI GÜNCELLE (YENİ KISIM)
            document.getElementById("dailyTotal").innerText = totalGenel;
            document.getElementById("totalSabah").innerText = totalSabah;
            document.getElementById("totalAksam").innerText = totalAksam;

            // Listeyi Çiz
            records.sort((a,b) => b.date.seconds - a.date.seconds);
            if(records.length===0) listDiv.innerHTML='<div class="text-center text-muted mt-3">Kayıt yok.</div>';
            else {
                records.forEach(rec => {
                    const isSabah = rec.period === 'sabah';
                    const bgClass = isSabah ? 'sabah-bg' : 'aksam-bg';
                    const iconClass = isSabah ? 'fa-regular fa-sun' : 'fa-regular fa-moon';
                    const borderClass = isSabah ? 'border-sabah' : 'border-aksam';
                    const time = new Date(rec.date.seconds * 1000).toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});

                    const item = `
                        <div class="record-item ${borderClass}">
                            <div class="d-flex align-items-center">
                                <div class="icon-box ${bgClass}"><i class="${iconClass}"></i></div>
                                <div><div class="fw-bold text-dark fs-5">${rec.memberName}</div><small class="text-muted">${time}</small></div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold fs-4 text-dark mb-1">${rec.liters} Lt</div>
                                <div class="action-btns d-flex justify-content-end">
                                    <button class="btn-edit-rec" onclick="duzenle('${rec.id}', '${rec.liters}', '${rec.memberName}')"><i class="fa-solid fa-pen"></i></button>
                                    <button class="btn-del-rec" onclick="sil('${rec.id}')"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>`;
                    listDiv.innerHTML += item;
                });
            }
        });
    }
   // KAYIT DÜZENLEME (MİKTAR GÜNCELLEME)
    window.duzenle = async function(id, mevcutLitre, isim) {
        const { value: yeniLitre } = await Swal.fire({
            title: 'Miktarı Düzenle',
            text: isim,
            input: 'number',
            inputValue: mevcutLitre,
            showCancelButton: true,
            confirmButtonText: 'Güncelle',
            confirmButtonColor: '#0284c7',
            cancelButtonText: 'İptal',
            inputAttributes: { step: '0.1', min: '0' }
        });

        if (yeniLitre && yeniLitre !== mevcutLitre) {
            try {
                const docRef = doc(db, "milk_records", id);
                await updateDoc(docRef, { 
                    liters: Number(yeniLitre) 
                });
                
                // --- YENİ BİLDİRİM BURASI ---
                Swal.fire({
                    icon: 'success',
                    title: 'Güncellendi!',
                    text: 'Süt miktarı başarıyla değiştirildi.',
                    timer: 1500,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error(error);
                Swal.fire("Hata", "Güncellenemedi", "error");
            }
        }
    }

    // MODERN SİLME ONAYI
    window.sil = async function(id) {
        const result = await Swal.fire({
            title: 'Silmek istiyor musunuz?',
            text: "Bu kayıt listeden kaldırılacak!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626', // Kırmızı renk
            cancelButtonColor: '#64748b',  // Gri renk
            confirmButtonText: 'Evet, Sil',
            cancelButtonText: 'Vazgeç',
            iconColor: '#ef4444',
            background: '#fff',
            borderRadius: '15px'
        });

        if (result.isConfirmed) {
            try {
                await deleteDoc(doc(db, "milk_records", id));
                
                // Silindiğine dair ufak bildirim
                const Toast = Swal.mixin({toast: true, position: 'top', showConfirmButton: false, timer: 1000});
                Toast.fire({ icon: 'success', title: 'Silindi' });
            } catch (error) {
                Swal.fire("Hata", "Silinemedi", "error");
            }
        }
    }
    window.cikisYap = async function() {
        const res = await Swal.fire({
            title: 'Çıkış Yap',
            text: 'Oturumu kapatmak istiyor musunuz?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Evet, Çık',
            confirmButtonColor: '#d33',
            cancelButtonText: 'Hayır'
        });
        
        if(res.isConfirmed) {
            await signOut(auth);
            window.location.href = "../index.html";
        }
    }
</script>
</body>
</html>