<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
  <style>
    :root {
        --primary-color: #0f766e;
        --primary-dark: #134e4a;
        --primary-gradient: linear-gradient(135deg, #0f766e 0%, #0e7490 100%);
        --sidebar-bg: linear-gradient(180deg, #115e59 0%, #0f766e 100%);
        --bg-body: #f1f5f9;
        --sidebar-width: 260px;
    }

    body { 
        background-color: var(--bg-body); 
        font-family: 'Inter', 'Segoe UI', sans-serif; 
        overflow-x: hidden;
        margin: 0;
    }
    
    /* 1. SIDEBAR (SOL MENÜ - RENKLİ & DİNAMİK) */
    .sidebar {
        width: var(--sidebar-width); 
        height: 100vh; 
        position: fixed;
        top: 0; left: 0;
        background: var(--sidebar-bg);
        color: white;
        z-index: 1050; 
        display: flex; flex-direction: column;
        transition: all 0.3s ease;
        box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    }
    
    .sidebar-brand {
        height: 70px; /* Daha kompakt logo alanı */
        padding: 0 25px;
        font-size: 1.3rem; font-weight: 800;
        color: white;
        display: flex; align-items: center; gap: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .nav-link { 
        color: rgba(255,255,255,0.9);
        padding: 12px 20px; 
        margin: 6px 15px; 
        border-radius: 10px;
        font-weight: 500; 
        font-size: 0.95rem;
        transition: all 0.2s;
        display: flex; align-items: center; gap: 12px;
    }
    
    .nav-link:hover {
        background-color: rgba(255,255,255,0.15);
        color: white;
        transform: translateX(5px);
    }
    
    .nav-link.active {
        background: white;
        color: var(--primary-color);
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .nav-link.active i { color: var(--primary-color); }

    .logout-link { margin-top: auto; margin-bottom: 30px; color: #fca5a5 !important; }
    .logout-link:hover { background-color: rgba(220, 38, 38, 0.2); color: #fecaca !important; }

    /* 2. ANA İÇERİK ALANI */
    .main-content { 
        margin-left: var(--sidebar-width); 
        min-height: 100vh;
        position: relative;
        display: flex; flex-direction: column;
    }

    /* --- ÜST KISIM (HEADER) AYARLARI --- */

    .admin-header {
        background: var(--primary-gradient);
        /* Üstten 20px: Başlığı yukarı yaklaştırdık.
           Alttan 50px: Kartların tutunacağı payı bıraktık.
           Yani toplam yükseklik azaldı.
        */
        padding: 20px 30px 50px 30px; 
        color: white;
        position: relative;
        z-index: 1;
    }
    
    .header-title h2 { 
        font-weight: 800; margin: 0; font-size: 1.6rem; /* Font biraz küçüldü */
        line-height: 1.2;
    }
    .header-title small { opacity: 0.9; font-size: 0.85rem; letter-spacing: 0.5px; }
    
    .user-badge {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(5px);
        padding: 6px 14px;
        border-radius: 50px;
        color: white; border: 1px solid rgba(255,255,255,0.3);
        font-size: 0.85rem;
    }

    /* --- KARTLARI YUKARI ÇEKME AYARI (HATA DÜZELTİLDİ) --- */
    .content-wrapper {
        /* Header'ın alt boşluğu 50px iken, kartları sadece 25px yukarı çekiyoruz.
           Böylece arada 25px güvenli mesafe kalıyor. Yazıya değme şansı yok.
        */
        margin-top: -25px; 
        padding: 0 30px 30px 30px;
        position: relative;
        z-index: 10;
    }
    /* ----------------------------------------------------- */

    .card { 
        border: none; border-radius: 16px; background: white;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05); /* Gölge hafifletildi */
        transition: transform 0.2s, box-shadow 0.2s; overflow: hidden;
    }
    .dash-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(14, 116, 144, 0.1); }
    
    .dash-card { padding: 25px; position: relative; height: 100%; display: flex; flex-direction: column; justify-content: center; }
    .dash-icon {
        position: absolute; right: -10px; bottom: -10px;
        font-size: 5rem; opacity: 0.05; transform: rotate(-10deg);
    }
    .dash-val { font-size: 2.2rem; font-weight: 800; color: #1e293b; line-height: 1; margin-top: 5px; }
    .dash-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; font-weight: 700; }

    /* Tablo ve Diğerleri */
    .table-custom thead th { 
        background-color: #f8fafc; color: #475569; padding: 12px; 
        font-size: 0.75rem; text-transform: uppercase; font-weight: 700;
        border-bottom: 2px solid #e2e8f0;
    }
    .table-custom tbody td { padding: 12px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; color: #334155; }
    
    .btn-primary-custom {
        background-color: #0e7490; color: white; border: none; padding: 8px 20px;
        border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(14, 116, 144, 0.2);
    }
    .btn-primary-custom:hover { background-color: #155e75; transform: translateY(-2px); color: white; }

    .settings-card { padding: 30px 15px; cursor: pointer; border: 2px solid transparent; text-align: center; }
    .settings-card:hover { border-color: #bae6fd; background: #f0f9ff; }
    .s-icon { width: 60px; height: 60px; border-radius: 18px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
    .icon-blue { background: #e0f2fe; color: #0369a1; }
    .icon-green { background: #dcfce7; color: #15803d; }
    .icon-purple { background: #f3e8ff; color: #7e22ce; }

    .hidden-section { display: none !important; }

    /* MOBİL AYARLAR */
    @media (max-width: 992px) {
        .sidebar { transform: translateX(-100%); }
        .main-content { margin-left: 0; }
        .admin-header { padding: 20px 20px 40px 20px; text-align: center; }
        .content-wrapper { margin-top: -20px; padding: 0 20px 20px 20px; }
        .d-flex.justify-content-between { flex-direction: column; gap: 15px; }
        .user-badge { align-self: center; }
    }
    /* --- CARİ HESAP STİLLERİ (YENİ) --- */
    .balance-card {
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;
        position: relative; overflow: hidden;
    }
    .balance-card::after {
        content: '\f51e'; font-family: "Font Awesome 6 Free"; font-weight: 900;
        position: absolute; right: -20px; bottom: -30px; font-size: 8rem; opacity: 0.05; transform: rotate(-15deg);
    }
    .b-val { font-size: 2rem; font-weight: 800; line-height: 1.1; }
    
    .action-btn {
        border: none; padding: 10px; border-radius: 12px; width: 100%;
        font-weight: 700; display: flex; flex-direction: column; align-items: center;
        gap: 5px; height: 90px; justify-content: center; transition: transform 0.2s;
    }
    .action-btn:hover { transform: translateY(-3px); }
    .btn-satis { background: #fee2e2; color: #dc2626; } /* Borçlandırır */
    .btn-tahsilat { background: #dcfce7; color: #166534; } /* Alacaklandırır */
    
    .badge-trans { padding: 5px 10px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; }
    .bg-borc { background: #fee2e2; color: #991b1b; }
    .bg-alacak { background: #dcfce7; color: #166534; }
    /* --- YENİ CARİ TASARIM CSS --- */

/* 1. Liste Görünümü Güzelleştirme */
.member-row {
    transition: all 0.2s;
    border-left: 4px solid transparent;
}
.member-row:hover {
    background-color: #f8fafc;
    transform: translateX(5px);
    border-left-color: var(--primary-color);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

/* 2. Offcanvas (Sağdan Açılan Panel) Özelleştirme */
.offcanvas-custom {
    border-top-left-radius: 25px;
    border-bottom-left-radius: 25px;
    box-shadow: -10px 0 30px rgba(0,0,0,0.1) !important;
}
.offcanvas-header-custom {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: white;
    padding: 30px 25px;
    position: relative;
    overflow: hidden;
}
/* Arka plan süslemeleri */
.offcanvas-header-custom::before {
    content: ''; position: absolute; top: -50px; right: -50px;
    width: 200px; height: 200px; background: rgba(255,255,255,0.05);
    border-radius: 50%;
}
.offcanvas-header-custom::after {
    content: ''; position: absolute; bottom: -30px; left: -30px;
    width: 150px; height: 150px; background: rgba(255,255,255,0.03);
    border-radius: 50%;
}

/* 3. Bakiye Kartı (Bankacılık Stili) */
.balance-display {
    text-align: center;
    margin-top: 10px;
}
.balance-amount {
    font-size: 2.8rem;
    font-weight: 800;
    letter-spacing: -1px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.balance-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    opacity: 0.7;
    font-weight: 600;
}

/* 4. Timeline (Zaman Çizelgesi) İşlem Geçmişi */
.timeline {
    position: relative;
    padding: 20px 0;
}
.timeline-item {
    position: relative;
    padding-left: 45px;
    margin-bottom: 25px;
}
/* Çizgi */
.timeline-item::before {
    content: '';
    position: absolute;
    left: 14px; top: 0; bottom: -25px;
    width: 2px;
    background: #e2e8f0;
}
.timeline-item:last-child::before { display: none; }
/* Nokta */
.timeline-dot {
    position: absolute;
    left: 0; top: 5px;
    width: 30px; height: 30px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: white;
    border: 4px solid #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 2;
}
/* Renkler */
.dot-borc { background-color: #fee2e2; color: #dc2626; }
.dot-alacak { background-color: #dcfce7; color: #166534; }

.timeline-content {
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    border: 1px solid #f1f5f9;
}

/* 5. Alt Aksiyon Çubuğu (Sticky) */
.bottom-actions {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    background: white;
    padding: 15px 25px;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    display: flex; gap: 10px;
    z-index: 10;
}
/* 1. Üst Bilgi Kartı (Daha Kompakt Hali) */
.account-header-card {
    background: linear-gradient(135deg, #0f766e 0%, #0e7490 100%);
    border-radius: 12px;       /* Köşe yuvarlaklığı biraz azaltıldı */
    padding: 15px 20px;        /* İÇ BOŞLUKLAR YARIYA İNDİRİLDİ (Eskisi 30px idi) */
    color: white;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(14, 116, 144, 0.2);
    position: relative;
    overflow: hidden;
}

/* Arka plan süsü (Cüzdan İkonu) - Küçültüldü */
.account-header-card::after {
    content: '\f555';
    font-family: "Font Awesome 6 Free"; font-weight: 900;
    position: absolute; right: -10px; bottom: -20px;
    font-size: 6rem;           /* İKON BOYUTU KÜÇÜLTÜLDÜ (Eskisi 10rem idi) */
    opacity: 0.1; transform: rotate(-15deg);
}

/* Bakiye Yazı Boyutu */
.acc-balance-big { 
    font-size: 2.2rem;         /* YAZI BOYUTU KÜÇÜLTÜLDÜ (Eskisi 3.5rem idi) */
    font-weight: 800; 
    line-height: 1; 
    letter-spacing: -0.5px; 
}

.acc-label { 
    text-transform: uppercase; 
    font-size: 0.7rem; 
    letter-spacing: 1px; 
    opacity: 0.9; 
    font-weight: 600; 
}

.acc-balance-big { font-size: 3.5rem; font-weight: 800; line-height: 1; letter-spacing: -1px; }
.acc-label { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 2px; opacity: 0.8; font-weight: 700; }

/* --- YENİ YATAY BUTON TASARIMI --- */

.quick-action-btn {
    border: none;
    background: white;
    padding: 15px 20px;       /* Yükseklik dengelendi */
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    transition: all 0.2s ease;
    width: 100%;              /* Bulunduğu alanı tam doldur */
    height: 100%;             
    
    /* İÇERİK DÜZENİ: YAN YANA (ROW) */
    display: flex; 
    flex-direction: row;      
    align-items: center;      
    justify-content: flex-start; /* Sola yasla */
    gap: 15px;                /* İkon ve yazı arası boşluk */
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

/* Hover Efekti */
.quick-action-btn:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
    background-color: #f8fafc;
}

/* Tıklama Efekti */
.quick-action-btn:active {
    transform: scale(0.98);
}

/* İkon Kutusu */
.btn-icon-circle {
    width: 45px; height: 45px; 
    border-radius: 10px;       
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;            /* Daralınca ikon ezilmesin */
    margin-bottom: 0;          /* Alt boşluk kaldırıldı */
}

/* Sağ tarafa hafif ok işareti (Süsleme) */
.quick-action-btn::after {
    content: '\f054'; /* FontAwesome sağ ok */
    font-family: "Font Awesome 6 Free"; font-weight: 900;
    position: absolute; right: 20px;
    color: #cbd5e1;
    font-size: 0.9rem;
    opacity: 0.7;
}

/* 3. Hesap Hareketleri Listesi */
.trans-item {
    background: white;
    border-bottom: 1px solid #f1f5f9;
    padding: 15px 20px;
    display: flex; align-items: center; justify-content: space-between;
    transition: background 0.1s;
}
.trans-item:hover { background: #f8fafc; }
.trans-item:last-child { border-bottom: none; }

.trans-icon {
    width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; margin-right: 15px;
}
/* --- YENİ HESAP EKSTRESİ TABLOSU --- */
.table-ledger {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9rem;
}

.table-ledger thead th {
    background-color: #f8fafc; /* Açık gri başlık */
    color: #475569;
    font-weight: 700;
    padding: 15px 10px;
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
    white-space: nowrap;
}

.table-ledger tbody td {
    padding: 12px 10px;
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
    vertical-align: middle;
}

.table-ledger tbody tr:hover {
    background-color: #f1f5f9; /* Üzerine gelince parlasın */
}

/* Renklendirme Sınıfları */
.text-borc { color: #dc2626; font-weight: 700; }   /* Kırmızı (Veresiye) */
.text-alacak { color: #166534; font-weight: 700; } /* Yeşil (Ödeme) */
.text-bakiye { color: #0f172a; font-weight: 800; font-size: 1rem; } /* Koyu (Kalan) */

/* Mobilde önemsiz sütunları gizle */
@media (max-width: 768px) {
    .hide-mobile { display: none; }
    .table-ledger { font-size: 0.8rem; }
}
</style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-brand" id="brandTitle">
        <i class="fa-solid fa-cube"></i> KOOP SİSTEM
    </div>
    
    <div class="d-flex flex-column flex-grow-1 mt-4">
        <a class="nav-link active" onclick="switchTab('dashboard', this)">
            <i class="fa-solid fa-chart-pie" style="width:20px"></i> Genel Durum
        </a>
        <a class="nav-link" onclick="switchTab('members', this)">
            <i class="fa-solid fa-users" style="width:20px"></i> <span id="lblMenuMembers">Üye İşlemleri</span>
        </a>
        <a class="nav-link" onclick="switchTab('settings', this)">
            <i class="fa-solid fa-sliders" style="width:20px"></i> Ayarlar
        </a>
        
        <a class="nav-link logout-link" id="logoutBtn">
            <i class="fa-solid fa-arrow-right-from-bracket" style="width:20px"></i> Çıkış Yap
        </a>
    </div>
</div>

<div class="main-content">
    
    <div class="admin-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-title">
                <small class="text-white-50 text-uppercase fw-bold" id="lblCompanyName">Yükleniyor...</small>
                <h2 id="page-title">Genel Bakış</h2>
            </div>
            
            <div class="user-badge">
                <i class="fa-solid fa-circle-user fa-lg"></i>
                <span class="small fw-bold" id="userEmailDisplay">Yönetici</span>
            </div>
        </div>
    </div>

    <div class="content-wrapper">

        <div id="dashboard" class="content-section">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card dash-card border-start border-4 border-info">
                        <div class="dash-label" id="lblDashTotal">TOPLAM KAYIT</div>
                        <div class="dash-val" id="dashTotalMember">0</div>
                        <i class="fa-solid fa-users dash-icon text-info"></i>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card dash-card border-start border-4 border-success">
                        <div class="dash-label">GÜNLÜK İŞLEM</div>
                        <div class="dash-val">0 <small class="fs-6 text-muted">Lt</small></div>
                        <i class="fa-solid fa-flask dash-icon text-success"></i>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card dash-card border-start border-4 border-warning">
                        <div class="dash-label">AKTİF ARAÇ</div>
                        <div class="dash-val">1</div>
                        <i class="fa-solid fa-truck-fast dash-icon text-warning"></i>
                    </div>
                </div>
            </div>
        </div>

        <div id="members" class="content-section hidden-section">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    <div>
                        <h4 class="m-0 fw-bold text-dark" id="lblListTitle">Kayıt Listesi</h4>
                        <small class="text-muted" id="recordCount">Yükleniyor...</small>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <div class="input-group" style="width: 250px;">
                            <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="Hızlı ara...">
                        </div>
                        <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addMemberModal" id="btnAddMember">
                            <i class="fa-solid fa-plus me-1"></i> Yeni
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead>
                            <tr>
                                <th>Sıra</th>
                                <th id="thName">Ad Soyad</th>
                                <th>Bölge / Köy</th>
                                <th>Telefon</th>
                                <th class="text-end">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings" class="content-section hidden-section">
            
            <div id="settings-main-menu">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card settings-card" onclick="openSubSetting('sub-regions')">
                            <div class="s-icon icon-blue"><i class="fa-solid fa-map-location-dot"></i></div>
                            <h5 class="fw-bold text-dark">Bölgeler & Rotalar</h5>
                            <small class="text-muted d-block">Köy tanımları ve rota düzeni</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card settings-card" onclick="Swal.fire('Bilgi','Bu modül yapım aşamasında','info')">
                            <div class="s-icon icon-green"><i class="fa-solid fa-turkish-lira-sign"></i></div>
                            <h5 class="fw-bold text-dark">Fiyatlandırma</h5>
                            <small class="text-muted d-block">Birim fiyat ve primler</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card settings-card">
                            <div class="s-icon icon-purple"><i class="fa-solid fa-shield-halved"></i></div>
                            <h5 class="fw-bold text-dark">Yetkiler</h5>
                            <small class="text-muted d-block">Kullanıcı ve yönetici rolleri</small>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sub-regions" class="d-none sub-setting-page">
                <div class="d-flex align-items-center mb-4">
                    <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeSubSetting()" style="width: 45px; height: 45px;">
                        <i class="fa-solid fa-arrow-left text-primary"></i>
                    </button>
                    <h4 class="m-0 fw-bold">Bölge Ayarları</h4>
                </div>

                <div class="row g-4">
                    <div class="col-md-7">
                        <div class="card p-4 h-100">
                            <h6 class="text-uppercase text-muted fw-bold mb-3 small">Yeni Bölge Ekle</h6>
                            <form id="addVillageForm" class="d-flex gap-2 mb-4">
                                <input type="text" class="form-control form-control-lg" id="newVillageInput" placeholder="Köy/Mahalle Adı" required>
                                <button type="submit" class="btn btn-primary-custom px-4">Ekle</button>
                            </form>
                            
                            <hr class="text-muted opacity-25">
                            
                            <h6 class="text-uppercase text-muted fw-bold mb-3 small">Kayıtlı Rotalar</h6>
                            <div id="villageList" class="d-grid gap-2" style="max-height: 400px; overflow-y: auto;">
                                </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                         <div class="card p-4 h-100 bg-light border-0">
                            <h6 class="text-danger fw-bold mb-3"><i class="fa-solid fa-triangle-exclamation me-2"></i>Güvenlik Limiti</h6>
                            <p class="small text-muted">Şoförler dünkü veriden % kaç sapma yaparsa uyarı verilsin?</p>
                            
                            <div class="input-group mb-3">
                                <input type="number" class="form-control" id="sapmaInput" placeholder="Örn: 50">
                                <span class="input-group-text">%</span>
                                <button class="btn btn-dark" onclick="limitKaydet()">Kaydet</button>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="account-detail-page" class="content-section hidden-section">
            
            <button class="btn btn-primary-custom shadow mb-4 mt-4 px-4 rounded-pill fw-bold" onclick="listeyeDon()">
    <i class="fa-solid fa-arrow-left me-2"></i> LİSTEYE DÖN
</button>
<div class="account-header-card">
                <div class="row align-items-center">
                    
                    <div class="col-lg-5 col-md-12 mb-3 mb-lg-0">
                        <h4 class="m-0 fw-bold text-white" id="detailName">Üye Adı</h4>
                        <small class="m-0 text-white-50" id="detailPhone">05XX...</small>
                    </div>

                    <div class="col-lg-7 col-md-12">
                        <div class="d-flex justify-content-between justify-content-lg-end align-items-center gap-3 gap-lg-4 text-end">
                            
                            <div>
                                <small class="d-block text-white-50 fw-bold" style="font-size: 0.65rem;">BORÇ</small>
                                <div class="fw-bold text-white fs-5" id="detailBorc">0 ₺</div>
                            </div>

                            <div class="border-end border-white border-opacity-25" style="height: 30px;"></div>

                            <div>
                                <small class="d-block text-white-50 fw-bold" style="font-size: 0.65rem;">ALACAK</small>
                                <div class="fw-bold text-white fs-5" id="detailAlacak">0 ₺</div>
                            </div>

                            <div class="border-end border-white border-opacity-25" style="height: 30px;"></div>

                            <div>
                                <small class="d-block text-warning fw-bold" style="font-size: 0.65rem;">BAKİYE</small>
                                <div class="fw-bold text-white" style="font-size: 1.8rem; line-height: 1;" id="detailBalance">0 ₺</div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

           <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
        <button class="quick-action-btn" onclick="yeniEvrakModalAc()">
            <div class="btn-icon-circle" style="background: #e0f2fe; color: #0284c7;">
                <i class="fa-solid fa-file-invoice"></i>
            </div>
            <div class="text-start">
                <div class="fw-bold text-dark">YENİ EVRAK</div>
                <small class="text-muted" style="font-size: 0.7rem;">Satış Faturası / Hizmet</small>
            </div>
        </button>
    </div>

    <div class="col-12 col-md-4">
        <button class="quick-action-btn" onclick="islemEkle('tahsilat')">
            <div class="btn-icon-circle" style="background: #dcfce7; color: #166534;">
                <i class="fa-solid fa-hand-holding-dollar"></i>
            </div>
            <div class="text-start">
                <div class="fw-bold text-dark">TAHSİLAT</div>
                <small class="text-muted" style="font-size: 0.7rem;">Nakit veya Banka</small>
            </div>
        </button>
    </div>

    <div class="col-12 col-md-4">
        <button class="quick-action-btn" onclick="Swal.fire('Bilgi','PDF Hazırlanıyor...','info')">
            <div class="btn-icon-circle bg-light text-secondary border">
                <i class="fa-solid fa-print"></i>
            </div>
            <div class="text-start">
                <div class="fw-bold text-dark">YAZDIR</div>
                <small class="text-muted" style="font-size: 0.7rem;">Ekstre Dökümü</small>
            </div>
        </button>
    </div>
</div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold text-dark"><i class="fa-solid fa-list-ul me-2 text-primary"></i>Hesap Hareketleri</h6>
                </div>
                <div class="table-responsive">
    <table class="table table-ledger align-middle mb-0">
        <thead>
            <tr>
                <th>Tarih</th>
                <th class="hide-mobile">Belge No</th>
                <th>Açıklama</th>
                <th class="text-end text-danger bg-light">Borç<br><small>(Mal Bedeli)</small></th>
                <th class="text-end text-success bg-light">Tahsilat<br><small>(Süt/Nakit)</small></th>
                <th class="text-end bg-white">Kalan Borç<br><small>(Bakiye)</small></th>
                <th class="text-end">İşlem</th>
            </tr>
        </thead>
        <tbody id="detailTableBody">
            </tbody>
    </table>
</div>
            </div>
        </div>

    </div> </div> <div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="lblModalTitle">Yeni Kayıt Oluştur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMemberForm">
                    <div class="row g-2 mb-3">
                        <div class="col-3">
                            <label class="small fw-bold text-muted">Sıra No</label>
                            <input type="number" class="form-control" id="uyeSira" placeholder="1">
                        </div>
                        <div class="col-9">
                            <label class="small fw-bold text-muted">Bölge / Rota</label>
                            <select class="form-select" id="uyeKoy" required>
                                <option value="">Seçiniz...</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">Adı</label>
                        <input type="text" class="form-control" id="uyeAd" required>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">Soyadı / Unvan</label>
                        <input type="text" class="form-control" id="uyeSoyad" required>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="small fw-bold text-muted">TC / Vergi No</label>
                            <input type="text" class="form-control" id="uyeTc">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-muted">Telefon</label>
                            <input type="text" class="form-control" id="uyeTel" placeholder="05...">
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary-custom">KAYDET</button>
                        <button type="button" class="btn btn-light text-danger btn-sm border" onclick="if(duzenlenecekId) uyeSil(duzenlenecekId)">Bu Kaydı Sil</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
   import { auth, db, signOut, onAuthStateChanged, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, getDoc, updateDoc, arrayUnion, arrayRemove, orderBy, limit } from "../js/firebase-config.js";

    let currentCoopId = null;
    let allMembers = [];
    let villageList = [];
    window.firmaTuru = "koop"; 

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            if(document.getElementById("userEmailDisplay")) {
                document.getElementById("userEmailDisplay").innerText = user.email;
            }
            currentCoopId = sessionStorage.getItem("coopId");
            
            if(currentCoopId) {
                sirketBilgileriniDinle(currentCoopId);
                canliUyeDinle();
            }
        } else { 
            window.location.href = "../index.html"; 
        }
    });

    // Şirket Ayarlarını Dinle
    function sirketBilgileriniDinle(id) {
        onSnapshot(doc(db, "cooperatives", id), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const lblCompany = document.getElementById("lblCompanyName");
                if(lblCompany) lblCompany.innerText = data.ad;
                
                const sapmaInput = document.getElementById("sapmaInput");
                if(sapmaInput) sapmaInput.value = data.deviationLimit || "";

                if (data.tur === "sahis") {
                    window.firmaTuru = "sahis";
                    if(document.getElementById("brandTitle")) document.getElementById("brandTitle").innerHTML = '<i class="fa-solid fa-shop"></i> FİRMA PANELİ';
                    if(document.getElementById("lblMenuMembers")) document.getElementById("lblMenuMembers").innerText = "Cari İşlemler";
                    if(document.getElementById("lblDashTotal")) document.getElementById("lblDashTotal").innerText = "Toplam Cari";
                    if(document.getElementById("lblListTitle")) document.getElementById("lblListTitle").innerText = "Cari Listesi";
                    if(document.getElementById("btnAddMember")) document.getElementById("btnAddMember").innerHTML = '<i class="fa-solid fa-plus me-2"></i> Yeni Cari';
                    if(document.getElementById("thName")) document.getElementById("thName").innerText = "Cari Adı / Unvan";
                    if(document.getElementById("lblModalTitle")) document.getElementById("lblModalTitle").innerText = "Yeni Cari Kartı";
                }

                villageList = data.villages || []; 
                ayarlarListesiniCiz();
                modalSelectDoldur();
            }
        });
    }

    // Ayarlar Listesini Çiz
    function ayarlarListesiniCiz() {
        const listDiv = document.getElementById("villageList");
        if(!listDiv) return;
        listDiv.innerHTML = "";
        
        if(!Array.isArray(villageList) || villageList.length === 0) {
            listDiv.innerHTML = '<div class="p-3 text-center text-muted">Henüz bölge eklenmemiş.</div>';
            return;
        }

        villageList.sort();
        villageList.forEach(koy => {
            const div = document.createElement("div");
            div.className = "d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm border";
            div.innerHTML = `
                <div class="fw-bold text-dark"><i class="fa-solid fa-location-dot text-primary me-2"></i>${koy}</div>
                <div>
                    <button class="btn btn-sm btn-light border text-primary me-1" onclick="bolgeDuzenle('${koy}')"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn btn-sm btn-light border text-danger" onclick="bolgeSil('${koy}')"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    function modalSelectDoldur() {
        const selectBox = document.getElementById("uyeKoy");
        if(!selectBox) return;
        selectBox.innerHTML = '<option value="">Seçiniz...</option>';
        if(Array.isArray(villageList)) {
            villageList.sort().forEach(koy => {
                const opt = document.createElement("option");
                opt.value = koy; opt.text = koy;
                selectBox.appendChild(opt);
            });
        }
    }

    // Tabloları Çiz
    function canliUyeDinle() {
        const q = query(collection(db, "members"), where("coopId", "==", currentCoopId));
        onSnapshot(q, (snapshot) => {
            allMembers = [];
            snapshot.forEach((doc) => { let d = doc.data(); d.id = doc.id; allMembers.push(d); });
            allMembers.sort((a,b) => (Number(a.sira) || 999) - (Number(b.sira) || 999));
            
            tabloyuCiz(allMembers);
            
            const dashTotal = document.getElementById("dashTotalMember");
            if(dashTotal) dashTotal.innerText = allMembers.length;
        });
    }

   function tabloyuCiz(data) {
        const tbody = document.getElementById("memberTableBody");
        if(!tbody) return;
        tbody.innerHTML = "";
        
        if (data.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' class='text-center text-muted py-4'>Kayıt bulunamadı.</td></tr>";
            return;
        }

        data.forEach(uye => {
            // member-row class'ı eklendi
            const row = `
                <tr class="member-row">
                    <td><span class="badge bg-white text-secondary border shadow-sm">${uye.sira || '-'}</span></td>
                    <td>
                        <div class="fw-bold text-dark">${uye.ad} ${uye.soyad}</div>
                        <small class="text-muted" style="font-size:0.75rem">${uye.tc || 'TC Yok'}</small>
                    </td>
                    <td><span class="badge bg-light text-dark border">${uye.koy}</span></td>
                    <td class="text-muted small">${uye.telefon}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-primary-custom me-1 shadow-sm" onclick="hesapAc('${uye.id}')">
                            <i class="fa-solid fa-chevron-right"></i> Detay
                        </button>
                        <button class="btn btn-sm btn-light border" onclick="uyeDuzenle('${uye.id}')"><i class="fa-solid fa-pen text-muted"></i></button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
        
        const recCount = document.getElementById("recordCount");
        if(recCount) recCount.innerText = `${data.length} cari hesap listelendi`;
    }
    // Fonksiyonlar (Sil, Ekle, Düzenle)
    window.limitKaydet = async function() {
        const val = document.getElementById("sapmaInput").value;
        try {
            await updateDoc(doc(db, "cooperatives", currentCoopId), { deviationLimit: Number(val) });
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Limit Kaydedildi', timer: 1500, showConfirmButton: false });
        } catch (error) { Swal.fire("Hata", "Kaydedilemedi", "error"); }
    }

    const addVillageForm = document.getElementById("addVillageForm");
    if(addVillageForm) {
        addVillageForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("newVillageInput");
            const yeniBolge = input.value.trim();
            if(!yeniBolge) return;
            if(Array.isArray(villageList) && villageList.includes(yeniBolge)) {
                Swal.fire("Uyarı", "Bu bölge zaten ekli!", "warning");
                return;
            }
            try {
                await updateDoc(doc(db, "cooperatives", currentCoopId), { villages: arrayUnion(yeniBolge) });
                input.value = "";
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Eklendi', timer: 1000, showConfirmButton: false });
            } catch (error) { console.error(error); }
        });
    }

    window.bolgeSil = async function(ad) {
        const res = await Swal.fire({ title: 'Silinsin mi?', text: `"${ad}" silinecek.`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Sil' });
        if(res.isConfirmed) await updateDoc(doc(db, "cooperatives", currentCoopId), { villages: arrayRemove(ad) });
    }

    window.bolgeDuzenle = async function(eskiAd) {
        const { value: yeniAd } = await Swal.fire({ title: 'Düzenle', input: 'text', inputValue: eskiAd, showCancelButton: true });
        if (yeniAd && yeniAd !== eskiAd) {
            const ref = doc(db, "cooperatives", currentCoopId);
            await updateDoc(ref, { villages: arrayRemove(eskiAd) });
            await updateDoc(ref, { villages: arrayUnion(yeniAd) });
        }
    }

    const searchInput = document.getElementById("searchInput");
    if(searchInput) {
        searchInput.addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            const filt = allMembers.filter(m => m.ad.toLowerCase().includes(val) || m.soyad.toLowerCase().includes(val));
            tabloyuCiz(filt);
        });
    }

    // Üye Ekleme / Düzenleme
    let duzenlenecekId = null; 
    const memberForm = document.getElementById("addMemberForm");
    if(memberForm) {
        memberForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const veri = {
                sira: Number(document.getElementById("uyeSira").value),
                ad: document.getElementById("uyeAd").value,
                soyad: document.getElementById("uyeSoyad").value,
                tc: document.getElementById("uyeTc").value,
                koy: document.getElementById("uyeKoy").value,
                telefon: document.getElementById("uyeTel").value,
                coopId: currentCoopId,
                ...(duzenlenecekId ? {} : { kayitTarihi: new Date() }) 
            };

            try {
                if (duzenlenecekId) {
                    await updateDoc(doc(db, "members", duzenlenecekId), veri);
                    Swal.fire({ icon: 'success', title: 'Güncellendi', timer: 1000, showConfirmButton: false });
                } else {
                    await addDoc(collection(db, "members"), veri);
                    Swal.fire({ icon: 'success', title: 'Eklendi', timer: 1000, showConfirmButton: false });
                }
                const modal = bootstrap.Modal.getInstance(document.getElementById('addMemberModal'));
                modal.hide();
                formuTemizle();
            } catch (error) { Swal.fire({ icon: 'error', title: 'Hata', text: error.message }); }
        });
    }

    window.uyeDuzenle = function(id) {
        const uye = allMembers.find(m => m.id === id);
        if (!uye) return;
        duzenlenecekId = id;
        document.getElementById("uyeSira").value = uye.sira || "";
        document.getElementById("uyeAd").value = uye.ad;
        document.getElementById("uyeSoyad").value = uye.soyad;
        document.getElementById("uyeTc").value = uye.tc || "";
        document.getElementById("uyeKoy").value = uye.koy;
        document.getElementById("uyeTel").value = uye.telefon;
        document.getElementById("lblModalTitle").innerText = "Kaydı Düzenle";
        new bootstrap.Modal(document.getElementById('addMemberModal')).show();
    }

    function formuTemizle() {
        document.getElementById("addMemberForm").reset();
        duzenlenecekId = null;
        document.getElementById("lblModalTitle").innerText = "Yeni Kayıt Oluştur";
    }

    window.uyeSil = async function(id) { 
        if((await Swal.fire({title:'Silinsin mi?',icon:'warning',showCancelButton:true})).isConfirmed) await deleteDoc(doc(db,"members",id)); 
    }

    document.getElementById("logoutBtn").addEventListener("click", async()=>{ 
        await signOut(auth); window.location.href="../index.html"; 
    });

    window.switchTab = function(tabId, el) { 
        document.querySelectorAll('.content-section').forEach(e=>e.classList.add('hidden-section')); 
        document.getElementById(tabId).classList.remove('hidden-section');
        document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
        if(el) el.classList.add('active');
        
        let t = "Genel Durum";
        if(tabId==='members') t = window.firmaTuru ==='sahis' ? "Cari İşlemleri" : "Üye İşlemleri";
        if(tabId==='settings') t = "Ayarlar";
        document.getElementById('page-title').innerText = t;
    }

    window.openSubSetting = function(id) {
        document.getElementById('settings-main-menu').classList.add('d-none');
        document.getElementById(id).classList.remove('d-none');
    }
    window.closeSubSetting = function() {
        document.querySelectorAll('.sub-setting-page').forEach(el => el.classList.add('d-none'));
        document.getElementById('settings-main-menu').classList.remove('d-none');
    }
    // --- CARİ HESAP FONKSİYONLARI ---
    
    let activeMemberId = null; 

  // 1. Listeden Detaya Geçiş (GÜNCELLENDİ)
    window.hesapAc = async function(id) {
        activeMemberId = id;
        const uye = allMembers.find(m => m.id === id);

        // İsim ve Başlıkları Doldur
        document.getElementById("detailName").innerText = `${uye.ad} ${uye.soyad}`;
        document.getElementById("detailPhone").innerText = `${uye.koy} • ${uye.telefon || 'Tel Yok'}`;

        // SAYFA DEĞİŞTİRME MANTIĞI:
        // 1. Tüm sayfaları gizle
        document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden-section'));
        
        // 2. !!! YENİ EKLENEN KISIM: Üstteki Genel Başlığı (Header) Gizle !!!
        document.querySelector('.admin-header').classList.add('d-none');
        
        // 3. Sadece Detay Sayfasını Aç
        const detailPage = document.getElementById('account-detail-page');
        detailPage.classList.remove('hidden-section');
        
        // Header gizlendiği için buton tavana yapışmasın diye üstten boşluk verelim
        detailPage.classList.add('pt-4'); 

        // Verileri Çekmeye Başla
        hareketleriDinle(id);
    }

    // 2. Detaydan Listeye Geri Dönüş (GÜNCELLENDİ)
    window.listeyeDon = function() {
        // Detay sayfasını gizle
        const detailPage = document.getElementById('account-detail-page');
        detailPage.classList.add('hidden-section');
        detailPage.classList.remove('pt-4'); // Boşluğu temizle

        // !!! YENİ EKLENEN KISIM: Üstteki Genel Başlığı Geri Getir !!!
        document.querySelector('.admin-header').classList.remove('d-none');

        // Listeyi göster
        document.getElementById('members').classList.remove('hidden-section');
        
        // Başlığı eski haline getir
        let t = window.firmaTuru === 'sahis' ? "Cari İşlemleri" : "Üye İşlemleri";
        document.getElementById('page-title').innerText = t;
    }

 // MEVCUT hareketleriDinle FONKSİYONUNU BUL VE BUNUNLA DEĞİŞTİR
    function hareketleriDinle(memId) {
        const q = query(
            collection(db, "transactions"), 
            where("memberId", "==", memId),
            orderBy("date", "asc") 
        );

        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById("detailTableBody");
            if(!tbody) return;
            tbody.innerHTML = "";

            if(snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Henüz işlem yok.</td></tr>';
                if(document.getElementById("detailBorc")) document.getElementById("detailBorc").innerText = "0 ₺";
                if(document.getElementById("detailAlacak")) document.getElementById("detailAlacak").innerText = "0 ₺";
                if(document.getElementById("detailBalance")) document.getElementById("detailBalance").innerText = "0 ₺";
                return;
            }

            let kumuletifBakiye = 0; 
            let toplamBorc = 0;
            let toplamAlacak = 0;
            
            snapshot.forEach(doc => {
                const t = doc.data();
                const miktar = Number(t.amount); // Bu artık GENEL TOPLAM
                const belgeNo = t.belgeNo || doc.id.substring(0,6).toUpperCase();
                const dateObj = t.date?.toDate();
                const tarih = dateObj ? dateObj.toLocaleDateString('tr-TR') : '-';
                
                let borcSutunu = "-";
                let alacakSutunu = "-";
                
                // Evrak tipine göre bakiye hesabı
                if (t.type === 'borc') {
                    kumuletifBakiye += miktar;
                    toplamBorc += miktar;
                    borcSutunu = `<span class="text-borc">${miktar.toLocaleString('tr-TR')} ₺</span>`;
                } else {
                    kumuletifBakiye -= miktar;
                    toplamAlacak += miktar;
                    alacakSutunu = `<span class="text-alacak">${miktar.toLocaleString('tr-TR')} ₺</span>`;
                }

                // EĞER BU BİR DETAYLI EVRAK İSE GÖZ İKONU KOY
                let detayBtn = '';
                if(t.items && t.items.length > 0) {
                    // Veriyi butona string olarak gömmek yerine ID ile çekeceğiz
                    detayBtn = `<button class="btn btn-sm btn-light border text-primary me-1" title="İçeriği Gör" onclick="evrakDetayGoster('${doc.id}')"><i class="fa-solid fa-eye"></i></button>`;
                }

                const tr = `
                    <tr>
                        <td class="fw-bold text-secondary">${tarih}</td>
                        <td class="hide-mobile"><span class="badge bg-light text-secondary border">#${belgeNo}</span></td>
                        <td>
                            <div class="fw-bold text-dark">${t.description || 'Evrak'}</div>
                            <small class="text-muted" style="font-size:0.7rem">${t.items ? t.items.length + ' Kalem Ürün' : t.category}</small>
                        </td>
                        <td class="text-end bg-light bg-opacity-25">${borcSutunu}</td>
                        <td class="text-end bg-light bg-opacity-25">${alacakSutunu}</td>
                        <td class="text-end"><span class="text-bakiye">${kumuletifBakiye.toLocaleString('tr-TR')} ₺</span></td>
                        <td class="text-end" style="min-width: 100px;">
                            ${detayBtn}
                            <button class="btn btn-sm btn-light border text-danger" onclick="islemSil('${doc.id}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('afterbegin', tr);
            });

            if(document.getElementById("detailBorc")) document.getElementById("detailBorc").innerText = toplamBorc.toLocaleString('tr-TR') + " ₺";
            if(document.getElementById("detailAlacak")) document.getElementById("detailAlacak").innerText = toplamAlacak.toLocaleString('tr-TR') + " ₺";
            if(document.getElementById("detailBalance")) document.getElementById("detailBalance").innerText = kumuletifBakiye.toLocaleString('tr-TR') + " ₺";
        });
    }

    // --- YENİ EKLENECEK FATURA FONKSİYONLARI ---

    window.yeniEvrakModalAc = function() {
        // Modalı temizle ve aç
        document.getElementById("faturaSatirlari").innerHTML = "";
        document.getElementById("evrakAciklama").value = "";
        document.getElementById("evrakBelgeNo").value = "";
        document.getElementById("evrakTarih").valueAsDate = new Date();
        document.getElementById("evrakGenelToplam").innerText = "0,00 ₺";
        
        // İlk boş satırı ekle
        satirEkle();
        
        new bootstrap.Modal(document.getElementById('evrakModal')).show();
    }

    window.satirEkle = function() {
        const tbody = document.getElementById("faturaSatirlari");
        const rowId = Date.now(); // Rastgele ID
        
        const tr = document.createElement("tr");
        tr.id = `row-${rowId}`;
        tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm item-name" placeholder="Ürün adı..."></td>
            <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" oninput="satirHesapla(${rowId})"></td>
            <td><input type="number" class="form-control form-control-sm item-price" placeholder="0" oninput="satirHesapla(${rowId})"></td>
            <td>
                <select class="form-select form-select-sm item-tax" onchange="satirHesapla(${rowId})">
                    <option value="0">0%</option>
                    <option value="1">1%</option>
                    <option value="10" selected>10%</option>
                    <option value="20">20%</option>
                </select>
            </td>
            <td><input type="text" class="form-control form-control-sm item-tax-amt" disabled value="0.00"></td>
            <td><input type="text" class="form-control form-control-sm fw-bold item-total" disabled value="0.00"></td>
            <td class="text-center"><button class="btn btn-sm text-danger" onclick="this.closest('tr').remove(); genelToplamHesapla();"><i class="fa-solid fa-times"></i></button></td>
        `;
        tbody.appendChild(tr);
    }

    // Global pencereye ata ki HTML'den çağırılabilsin
    window.satirHesapla = function(id) {
        const row = document.getElementById(`row-${id}`);
        const qty = Number(row.querySelector('.item-qty').value) || 0;
        const price = Number(row.querySelector('.item-price').value) || 0;
        const taxRate = Number(row.querySelector('.item-tax').value) || 0;

        const baseTotal = qty * price; // KDV Hariç Tutar
        const taxAmount = baseTotal * (taxRate / 100); // KDV Tutarı
        const grandTotal = baseTotal + taxAmount; // KDV Dahil Toplam

        row.querySelector('.item-tax-amt').value = taxAmount.toFixed(2);
        row.querySelector('.item-total').value = grandTotal.toFixed(2);
        
        genelToplamHesapla();
    }

    window.genelToplamHesapla = function() {
        let grandTotal = 0;
        document.querySelectorAll('.item-total').forEach(inp => {
            grandTotal += Number(inp.value) || 0;
        });
        document.getElementById("evrakGenelToplam").innerText = grandTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
    }

    window.evrakiKaydet = async function() {
        const items = [];
        let grandTotal = 0;
        
        // Tablodaki verileri topla
        document.querySelectorAll('#faturaSatirlari tr').forEach(row => {
            const name = row.querySelector('.item-name').value;
            const qty = row.querySelector('.item-qty').value;
            const price = row.querySelector('.item-price').value;
            const tax = row.querySelector('.item-tax').value;
            const total = row.querySelector('.item-total').value;
            
            if(name) { // Adı boş değilse ekle
                items.push({
                    name: name,
                    qty: Number(qty),
                    price: Number(price),
                    taxRate: Number(tax),
                    total: Number(total)
                });
                grandTotal += Number(total);
            }
        });

        if(items.length === 0) {
            Swal.fire("Hata", "En az bir ürün girmelisiniz!", "warning");
            return;
        }

        const evrakTuru = document.getElementById("evrakTuru").value; // satis veya iade
        const tarih = document.getElementById("evrakTarih").value;
        const belgeNo = document.getElementById("evrakBelgeNo").value;
        const aciklama = document.getElementById("evrakAciklama").value || (evrakTuru === 'satis' ? 'Vadeli Satış Faturası' : 'İade Faturası');

        try {
            await addDoc(collection(db, "transactions"), {
                memberId: activeMemberId,
                coopId: currentCoopId,
                type: evrakTuru === 'satis' ? 'borc' : 'alacak', // Satışsa BORÇ, İadeyse ALACAK
                category: 'Fatura',
                description: aciklama,
                amount: grandTotal,
                date: new Date(tarih),
                belgeNo: belgeNo,
                items: items // Ürün detaylarını dizi olarak kaydediyoruz
            });

            bootstrap.Modal.getInstance(document.getElementById('evrakModal')).hide();
            Swal.fire({ icon: 'success', title: 'Fatura İşlendi', timer: 1500, showConfirmButton: false });
        } catch (error) {
            console.error(error);
            Swal.fire("Hata", "Kaydedilemedi: " + error.message, "error");
        }
    }

    // Detayları Görme Fonksiyonu
    window.evrakDetayGoster = async function(docId) {
        const docRef = doc(db, "transactions", docId);
        const docSnap = await getDoc(docRef);
        
        if(docSnap.exists()) {
            const data = docSnap.data();
            const items = data.items || [];
            
            const tbody = document.getElementById("detayIcerik");
            tbody.innerHTML = "";
            
            items.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td class="text-center">${item.qty}</td>
                        <td class="text-end">${item.price} ₺</td>
                        <td class="text-end">%${item.taxRate}</td>
                        <td class="text-end fw-bold">${item.total.toFixed(2)} ₺</td>
                    </tr>
                `;
            });
            
            new bootstrap.Modal(document.getElementById('detayModal')).show();
        }
    }

    window.islemEkle = async function(islemTuru) {
        // islemTuru: 'satis' (Borç Artırır) veya 'tahsilat' (Alacak Artırır)
        const baslik = islemTuru === 'satis' ? 'Satış Gir (Borçlandır)' : 'Tahsilat / Alacak Ekle';
        const renk = islemTuru === 'satis' ? '#dc2626' : '#166534';
        
        // SweetAlert ile Form Aç
        const { value: formValues } = await Swal.fire({
            title: baslik,
            html: `
                <select id="swal-cat" class="form-select mb-3">
                    ${islemTuru === 'satis' 
                        ? '<option>Yem</option><option>Un</option><option>Kepek</option><option>Market</option>' 
                        : '<option>Nakit Tahsilat</option><option>Banka/Havale</option><option>Süt Bedeli</option>'}
                </select>
                <input id="swal-amt" class="form-control mb-3" type="number" placeholder="Tutar (TL)">
                <input id="swal-desc" class="form-control" placeholder="Açıklama (Opsiyonel)">
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonColor: renk,
            confirmButtonText: 'Kaydet',
            preConfirm: () => {
                return {
                    cat: document.getElementById('swal-cat').value,
                    amt: document.getElementById('swal-amt').value,
                    desc: document.getElementById('swal-desc').value
                }
            }
        });

        if (formValues && formValues.amt) {
            try {
                // Veritabanına Yaz
                await addDoc(collection(db, "transactions"), {
                    memberId: activeMemberId,
                    coopId: currentCoopId,
                    type: islemTuru === 'satis' ? 'borc' : 'alacak', // borc veya alacak
                    category: formValues.cat,
                    amount: Number(formValues.amt),
                    description: formValues.desc || formValues.cat,
                    date: new Date()
                });
                
                Swal.fire({ icon: 'success', title: 'İşlendi', timer: 1000, showConfirmButton: false });
            } catch (error) {
                console.error(error);
                Swal.fire('Hata', error.message, 'error');
            }
        }
    }
    
</script>
<div class="modal fade" id="evrakModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable"> <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold text-primary"><i class="fa-solid fa-file-invoice me-2"></i>Yeni Evrak Girişi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-3">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">İşlem Türü</label>
                                <select class="form-select" id="evrakTuru">
                                    <option value="satis">Satış (Borçlandır)</option>
                                    <option value="iade">İade Al (Alacaklandır)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">Tarih</label>
                                <input type="date" class="form-control" id="evrakTarih">
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">Belge No (Opsiyonel)</label>
                                <input type="text" class="form-control" id="evrakBelgeNo" placeholder="Otomatik">
                            </div>
                             <div class="col-md-3">
                                <label class="small fw-bold text-muted">Genel Açıklama</label>
                                <input type="text" class="form-control" id="evrakAciklama" placeholder="Örn: Yem Faturası">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0 small" id="faturaTablosu">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 25%">Ürün / Hizmet Adı</th>
                                        <th style="width: 10%">Miktar</th>
                                        <th style="width: 15%">Birim Fiyat</th>
                                        <th style="width: 10%">KDV %</th>
                                        <th style="width: 15%">KDV Tutarı</th>
                                        <th style="width: 15%">Toplam (KDV Dahil)</th>
                                        <th style="width: 5%">Sil</th>
                                    </tr>
                                </thead>
                                <tbody id="faturaSatirlari">
                                    </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="7">
                                            <button class="btn btn-sm btn-light border text-primary fw-bold w-100" onclick="satirEkle()">
                                                <i class="fa-solid fa-plus me-1"></i> Yeni Satır Ekle
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <div class="d-inline-block text-end">
                            <small class="text-muted d-block">GENEL TOPLAM</small>
                            <span class="fs-4 fw-bold text-dark" id="evrakGenelToplam">0,00 ₺</span>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary px-4 fw-bold" onclick="evrakiKaydet()">KAYDET</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detayModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Evrak Detayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Ürün Adı</th>
                            <th class="text-center">Adet</th>
                            <th class="text-end">Birim Fiyat</th>
                            <th class="text-end">KDV</th>
                            <th class="text-end">Tutar</th>
                        </tr>
                    </thead>
                    <tbody id="detayIcerik"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>