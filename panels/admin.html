<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
        --primary-color: #0f766e;
        --primary-dark: #134e4a;
        --primary-gradient: linear-gradient(135deg, #0f766e 0%, #0e7490 100%);
        --sidebar-bg: linear-gradient(180deg, #115e59 0%, #0f766e 100%);
        --bg-body: #f1f5f9;
        --sidebar-width: 260px;
    }

    body { 
        background-color: var(--bg-body); 
        font-family: 'Inter', 'Segoe UI', sans-serif; 
        overflow-x: hidden;
        margin: 0;
    }
    
    /* 1. SIDEBAR (SOL MENÜ - RENKLİ & DİNAMİK) */
    .sidebar {
        width: var(--sidebar-width); 
        height: 100vh; 
        position: fixed;
        top: 0; left: 0;
        background: var(--sidebar-bg);
        color: white;
        z-index: 1050; 
        display: flex; flex-direction: column;
        transition: all 0.3s ease;
        box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    }
    
    .sidebar-brand {
        height: 70px; /* Daha kompakt logo alanı */
        padding: 0 25px;
        font-size: 1.3rem; font-weight: 800;
        color: white;
        display: flex; align-items: center; gap: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .nav-link { 
        color: rgba(255,255,255,0.9);
        padding: 12px 20px; 
        margin: 6px 15px; 
        border-radius: 10px;
        font-weight: 500; 
        font-size: 0.95rem;
        transition: all 0.2s;
        display: flex; align-items: center; gap: 12px;
    }
    
    .nav-link:hover {
        background-color: rgba(255,255,255,0.15);
        color: white;
        transform: translateX(5px);
    }
    
    .nav-link.active {
        background: white;
        color: var(--primary-color);
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .nav-link.active i { color: var(--primary-color); }

    .logout-link { margin-top: auto; margin-bottom: 30px; color: #fca5a5 !important; }
    .logout-link:hover { background-color: rgba(220, 38, 38, 0.2); color: #fecaca !important; }

    /* 2. ANA İÇERİK ALANI */
    .main-content { 
        margin-left: var(--sidebar-width); 
        min-height: 100vh;
        position: relative;
        display: flex; flex-direction: column;
    }

    
    
    .header-title h2 { 
        font-weight: 800; margin: 0; font-size: 1.6rem; /* Font biraz küçüldü */
        line-height: 1.2;
    }
    .header-title small { opacity: 0.9; font-size: 0.85rem; letter-spacing: 0.5px; }
    
    .user-badge {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(5px);
        padding: 6px 14px;
        border-radius: 50px;
        color: white; border: 1px solid rgba(255,255,255,0.3);
        font-size: 0.85rem;
    }

   /* 1. Header'ın alt boşluğunu azaltıyoruz */
.admin-header {
    background: var(--primary-gradient);
    padding: 20px 30px 20px 30px; /* Alt boşluk 50px'den 20px'e düştü */
    color: white;
    position: relative;
    z-index: 1;
}

/* 2. Kartları yukarı çeken eksi değeri siliyoruz, aşağı itiyoruz */
.content-wrapper {
    margin-top: 20px; /* Eksi (-) kalktı, 20px boşluk verildi */
    padding: 0 30px 30px 30px;
    position: relative;
    z-index: 10;
}

    .card { 
        border: none; border-radius: 16px; background: white;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05); /* Gölge hafifletildi */
        transition: transform 0.2s, box-shadow 0.2s; overflow: hidden;
    }
    .dash-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(14, 116, 144, 0.1); }
    
    .dash-card { padding: 25px; position: relative; height: 100%; display: flex; flex-direction: column; justify-content: center; }
    .dash-icon {
        position: absolute; right: -10px; bottom: -10px;
        font-size: 5rem; opacity: 0.05; transform: rotate(-10deg);
    }
    .dash-val { font-size: 2.2rem; font-weight: 800; color: #1e293b; line-height: 1; margin-top: 5px; }
    .dash-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; font-weight: 700; }

    /* Tablo ve Diğerleri */
    .table-custom thead th { 
        background-color: #f8fafc; color: #475569; padding: 12px; 
        font-size: 0.75rem; text-transform: uppercase; font-weight: 700;
        border-bottom: 2px solid #e2e8f0;
    }
    .table-custom tbody td { padding: 12px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; color: #334155; }
    
    .btn-primary-custom {
        background-color: #0e7490; color: white; border: none; padding: 8px 20px;
        border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(14, 116, 144, 0.2);
    }
    .btn-primary-custom:hover { background-color: #155e75; transform: translateY(-2px); color: white; }

    .settings-card { padding: 30px 15px; cursor: pointer; border: 2px solid transparent; text-align: center; }
    .settings-card:hover { border-color: #bae6fd; background: #f0f9ff; }
    .s-icon { width: 60px; height: 60px; border-radius: 18px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
    .icon-blue { background: #e0f2fe; color: #0369a1; }
    .icon-green { background: #dcfce7; color: #15803d; }
    .icon-purple { background: #f3e8ff; color: #7e22ce; }

    .hidden-section { display: none !important; }

    /* MOBİL AYARLAR */
    @media (max-width: 992px) {
        .sidebar { transform: translateX(-100%); }
        .main-content { margin-left: 0; }
        .admin-header { padding: 20px 20px 40px 20px; text-align: center; }
        .content-wrapper { margin-top: -20px; padding: 0 20px 20px 20px; }
        .d-flex.justify-content-between { flex-direction: column; gap: 15px; }
        .user-badge { align-self: center; }
    }
    /* --- CARİ HESAP STİLLERİ (YENİ) --- */
    .balance-card {
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;
        position: relative; overflow: hidden;
    }
    .balance-card::after {
        content: '\f51e'; font-family: "Font Awesome 6 Free"; font-weight: 900;
        position: absolute; right: -20px; bottom: -30px; font-size: 8rem; opacity: 0.05; transform: rotate(-15deg);
    }
    .b-val { font-size: 2rem; font-weight: 800; line-height: 1.1; }
    
    .action-btn {
        border: none; padding: 10px; border-radius: 12px; width: 100%;
        font-weight: 700; display: flex; flex-direction: column; align-items: center;
        gap: 5px; height: 90px; justify-content: center; transition: transform 0.2s;
    }
    .action-btn:hover { transform: translateY(-3px); }
    .btn-satis { background: #fee2e2; color: #dc2626; } /* Borçlandırır */
    .btn-tahsilat { background: #dcfce7; color: #166534; } /* Alacaklandırır */
    
    .badge-trans { padding: 5px 10px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; }
    .bg-borc { background: #fee2e2; color: #991b1b; }
    .bg-alacak { background: #dcfce7; color: #166534; }
    /* --- YENİ CARİ TASARIM CSS --- */

/* 1. Liste Görünümü Güzelleştirme */
.member-row {
    transition: all 0.2s;
    border-left: 4px solid transparent;
}
.member-row:hover {
    background-color: #f8fafc;
    transform: translateX(5px);
    border-left-color: var(--primary-color);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

/* 2. Offcanvas (Sağdan Açılan Panel) Özelleştirme */
.offcanvas-custom {
    border-top-left-radius: 25px;
    border-bottom-left-radius: 25px;
    box-shadow: -10px 0 30px rgba(0,0,0,0.1) !important;
}
.offcanvas-header-custom {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: white;
    padding: 30px 25px;
    position: relative;
    overflow: hidden;
}
/* Arka plan süslemeleri */
.offcanvas-header-custom::before {
    content: ''; position: absolute; top: -50px; right: -50px;
    width: 200px; height: 200px; background: rgba(255,255,255,0.05);
    border-radius: 50%;
}
.offcanvas-header-custom::after {
    content: ''; position: absolute; bottom: -30px; left: -30px;
    width: 150px; height: 150px; background: rgba(255,255,255,0.03);
    border-radius: 50%;
}

/* 3. Bakiye Kartı (Bankacılık Stili) */
.balance-display {
    text-align: center;
    margin-top: 10px;
}
.balance-amount {
    font-size: 2.8rem;
    font-weight: 800;
    letter-spacing: -1px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.balance-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    opacity: 0.7;
    font-weight: 600;
}

/* 4. Timeline (Zaman Çizelgesi) İşlem Geçmişi */
.timeline {
    position: relative;
    padding: 20px 0;
}
.timeline-item {
    position: relative;
    padding-left: 45px;
    margin-bottom: 25px;
}
/* Çizgi */
.timeline-item::before {
    content: '';
    position: absolute;
    left: 14px; top: 0; bottom: -25px;
    width: 2px;
    background: #e2e8f0;
}
.timeline-item:last-child::before { display: none; }
/* Nokta */
.timeline-dot {
    position: absolute;
    left: 0; top: 5px;
    width: 30px; height: 30px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: white;
    border: 4px solid #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 2;
}
/* Renkler */
.dot-borc { background-color: #fee2e2; color: #dc2626; }
.dot-alacak { background-color: #dcfce7; color: #166534; }

.timeline-content {
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    border: 1px solid #f1f5f9;
}

/* 5. Alt Aksiyon Çubuğu (Sticky) */
.bottom-actions {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    background: white;
    padding: 15px 25px;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    display: flex; gap: 10px;
    z-index: 10;
}
/* 1. Üst Bilgi Kartı (Daha Kompakt Hali) */
.account-header-card {
    background: linear-gradient(135deg, #0f766e 0%, #0e7490 100%);
    border-radius: 12px;       /* Köşe yuvarlaklığı biraz azaltıldı */
    padding: 15px 20px;        /* İÇ BOŞLUKLAR YARIYA İNDİRİLDİ (Eskisi 30px idi) */
    color: white;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(14, 116, 144, 0.2);
    position: relative;
    overflow: hidden;
}

/* Arka plan süsü (Cüzdan İkonu) - Küçültüldü */
.account-header-card::after {
    content: '\f555';
    font-family: "Font Awesome 6 Free"; font-weight: 900;
    position: absolute; right: -10px; bottom: -20px;
    font-size: 6rem;           /* İKON BOYUTU KÜÇÜLTÜLDÜ (Eskisi 10rem idi) */
    opacity: 0.1; transform: rotate(-15deg);
}

/* Bakiye Yazı Boyutu */
.acc-balance-big { 
    font-size: 2.2rem;         /* YAZI BOYUTU KÜÇÜLTÜLDÜ (Eskisi 3.5rem idi) */
    font-weight: 800; 
    line-height: 1; 
    letter-spacing: -0.5px; 
}

.acc-label { 
    text-transform: uppercase; 
    font-size: 0.7rem; 
    letter-spacing: 1px; 
    opacity: 0.9; 
    font-weight: 600; 
}

.acc-balance-big { font-size: 3.5rem; font-weight: 800; line-height: 1; letter-spacing: -1px; }
.acc-label { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 2px; opacity: 0.8; font-weight: 700; }

/* --- YENİ YATAY BUTON TASARIMI --- */

.quick-action-btn {
    border: none;
    background: white;
    padding: 15px 20px;       /* Yükseklik dengelendi */
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    transition: all 0.2s ease;
    width: 100%;              /* Bulunduğu alanı tam doldur */
    height: 100%;             
    
    /* İÇERİK DÜZENİ: YAN YANA (ROW) */
    display: flex; 
    flex-direction: row;      
    align-items: center;      
    justify-content: flex-start; /* Sola yasla */
    gap: 15px;                /* İkon ve yazı arası boşluk */
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

/* Hover Efekti */
.quick-action-btn:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
    background-color: #f8fafc;
}

/* Tıklama Efekti */
.quick-action-btn:active {
    transform: scale(0.98);
}

/* İkon Kutusu */
.btn-icon-circle {
    width: 45px; height: 45px; 
    border-radius: 10px;       
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;            /* Daralınca ikon ezilmesin */
    margin-bottom: 0;          /* Alt boşluk kaldırıldı */
}
/* Modalı en öne zorla */
#sutHesaplaModal {
    z-index: 10000 !important;
}
/* Arka plan karartmasını da öne al */
.modal-backdrop {
    z-index: 9999 !important;
}
/* Sağ tarafa hafif ok işareti (Süsleme) */
.quick-action-btn::after {
    content: '\f054'; /* FontAwesome sağ ok */
    font-family: "Font Awesome 6 Free"; font-weight: 900;
    position: absolute; right: 20px;
    color: #cbd5e1;
    font-size: 0.9rem;
    opacity: 0.7;
}

/* 3. Hesap Hareketleri Listesi */
.trans-item {
    background: white;
    border-bottom: 1px solid #f1f5f9;
    padding: 15px 20px;
    display: flex; align-items: center; justify-content: space-between;
    transition: background 0.1s;
}
.trans-item:hover { background: #f8fafc; }
.trans-item:last-child { border-bottom: none; }

.trans-icon {
    width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; margin-right: 15px;
}
/* --- YENİ HESAP EKSTRESİ TABLOSU --- */
.table-ledger {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9rem;
}

.table-ledger thead th {
    background-color: #f8fafc; /* Açık gri başlık */
    color: #475569;
    font-weight: 700;
    padding: 15px 10px;
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
    white-space: nowrap;
}

.table-ledger tbody td {
    padding: 6px 10px; /* YENİ DEĞER: Satırlar daraldı */
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
    vertical-align: middle;
    font-size: 0.85rem; /* Yazı fontunu da bir tık küçülttük */
}

.table-ledger tbody tr:hover {
    background-color: #f1f5f9; /* Üzerine gelince parlasın */
}

/* Renklendirme Sınıfları */
.text-borc { color: #dc2626; font-weight: 700; }   /* Kırmızı (Veresiye) */
.text-alacak { color: #166534; font-weight: 700; } /* Yeşil (Ödeme) */
.text-bakiye { color: #0f172a; font-weight: 800; font-size: 1rem; } /* Koyu (Kalan) */

/* Mobilde önemsiz sütunları gizle */
@media (max-width: 768px) {
    .hide-mobile { display: none; }
    .table-ledger { font-size: 0.8rem; }
}
/* --- MODAL ÇAKIŞMA DÜZELTME KODU (EN ALTA EKLE) --- */
.modal {
    z-index: 1060 !important; /* Bootstrap varsayılanından yüksek */
}
.modal-backdrop {
    z-index: 1050 !important; /* Arka plan perdesi */
}
/* Detay penceresi içeriğinin beyaz kalmasını garantiye al */
#detayModal .modal-content {
    background-color: #fff !important;
    color: #000 !important;
}
/* --- DETAY PENCERESİ DİNAMİK TASARIM --- */

/* 1. Başlık Alanı - Gradyan Geçiş */
.modal-header-dynamic {
    background: linear-gradient(135deg, #0f766e 0%, #0e7490 100%); /* Sizin temanızla uyumlu */
    color: white;
    border-bottom: none;
    padding: 20px 25px;
    position: relative;
    overflow: hidden;
}

/* Başlığa hafif bir desen/ikon ekleyelim (Süsleme) */
.modal-header-dynamic::after {
    content: '\f543'; /* FontAwesome Makbuz İkonu */
    font-family: "Font Awesome 6 Free"; font-weight: 900;
    position: absolute;
    right: -10px; bottom: -20px;
    font-size: 6rem;
    opacity: 0.1;
    transform: rotate(-15deg);
}

.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%); /* Çarpı işaretini beyaz yap */
}

/* 2. Tablo Düzeni */
.table-invoice thead th {
    background-color: #f8fafc;
    color: #64748b;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid #e2e8f0;
    padding: 15px;
}
.table-invoice tbody td {
    padding: 15px;
    vertical-align: middle;
    color: #334155;
    font-size: 0.95rem;
    border-bottom: 1px solid #f1f5f9;
}
.table-invoice tbody tr:last-child td {
    border-bottom: none;
}
.table-invoice tbody tr:hover {
    background-color: #f1f5f9; /* Hover efekti */
}

/* 3. Alt Özet Kartı (Receipt Style) */
.summary-box {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05); /* Havada durma efekti */
    position: relative;
}
/* Sol tarafına renkli çizgi */
.summary-box::before {
    content: ''; position: absolute; left: 0; top: 15px; bottom: 15px;
    width: 4px; background: #0e7490; border-radius: 0 4px 4px 0;
}

.total-row {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px; font-size: 0.9rem; color: #64748b;
}
.total-final {
    border-top: 2px dashed #e2e8f0;
    margin-top: 10px; padding-top: 10px;
    display: flex; justify-content: space-between; align-items: center;
}
.big-total {
    font-size: 1.6rem; font-weight: 800; color: #0f766e; letter-spacing: -0.5px;
}

/* Açıklama Kutusu */
.note-box {
    background-color: #fffbeb; /* Hafif sarımsı not kağıdı rengi */
    border: 1px solid #fcd34d;
    color: #92400e;
    border-radius: 8px;
    padding: 15px;
    font-size: 0.85rem;
    height: 100%;
}
/* Süt Yönetimi alanını öne çıkar */
#milk-management {
    position: relative;
    z-index: 50 !important; /* Diğer her şeyin önüne geç */
}

/* Header ve Sidebar'ın butonun üstüne binmesini engelle */
.admin-header {
    z-index: 1 !important; /* Arkada kalsın */
}

/* Butonun kendisine tıklamayı garanti et */
#milk-management button {
    position: relative;
    z-index: 100 !important;
    cursor: pointer;
}
</style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-brand" id="brandTitle">
        <i class="fa-solid fa-cube"></i> KOOP SİSTEM
    </div>
    
    <div class="d-flex flex-column flex-grow-1 mt-4">
        <a class="nav-link active" onclick="switchTab('dashboard', this)">
            <i class="fa-solid fa-chart-pie" style="width:20px"></i> Ana Sayfa
        </a>
        <a class="nav-link" onclick="switchTab('reports', this)">
    <i class="fa-solid fa-chart-line" style="width:20px"></i> Dashboard
</a>
        <a class="nav-link" onclick="switchTab('members', this)">
            <i class="fa-solid fa-users" style="width:20px"></i> <span id="lblMenuMembers">Üye İşlemleri</span>
        </a>
        <a class="nav-link" onclick="switchTab('stocks', this)">
    <i class="fa-solid fa-boxes-stacked" style="width:20px"></i> Stok Yönetimi
</a>
<a class="nav-link" onclick="switchTab('milk-management', this)">
    <i class="fa-solid fa-cow" style="width:20px"></i> Süt Yönetimi
</a>
<a class="nav-link" onclick="switchTab('advanced-reports', this)">
    <i class="fa-solid fa-file-contract" style="width:20px"></i> Detaylı Raporlar
</a>
        <a class="nav-link" onclick="switchTab('settings', this)">
            <i class="fa-solid fa-sliders" style="width:20px"></i> Ayarlar
        </a>
        
        <a class="nav-link logout-link" id="logoutBtn">
            <i class="fa-solid fa-arrow-right-from-bracket" style="width:20px"></i> Çıkış Yap
        </a>
    </div>
</div>

<div class="main-content">
    
    <div class="admin-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-title">
                <small class="text-white-50 text-uppercase fw-bold" id="lblCompanyName">Yükleniyor...</small>
                <h2 id="page-title">Genel Bakış</h2>
            </div>
            
            <div class="user-badge">
                <i class="fa-solid fa-circle-user fa-lg"></i>
                <span class="small fw-bold" id="userEmailDisplay">Yönetici</span>
            </div>
        </div>
    </div>

    <div class="content-wrapper">

        <div id="dashboard" class="content-section">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card dash-card border-start border-4 border-info">
                        <div class="dash-label" id="lblDashTotal">TOPLAM KAYIT</div>
                        <div class="dash-val" id="dashTotalMember">0</div>
                        <i class="fa-solid fa-users dash-icon text-info"></i>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card dash-card border-start border-4 border-success">
                        <div class="dash-label">GÜNLÜK İŞLEM</div>
                        <div class="dash-val">0 <small class="fs-6 text-muted">Lt</small></div>
                        <i class="fa-solid fa-flask dash-icon text-success"></i>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card dash-card border-start border-4 border-warning">
                        <div class="dash-label">AKTİF ARAÇ</div>
                        <div class="dash-val">1</div>
                        <i class="fa-solid fa-truck-fast dash-icon text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
<div id="reports" class="content-section hidden-section">
    
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Başlangıç Tarihi</label>
                    <input type="date" class="form-control" id="reportStartDate">
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Bitiş Tarihi</label>
                    <input type="date" class="form-control" id="reportEndDate">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary-custom w-100" onclick="raporlariGetir()">
                        <i class="fa-solid fa-filter me-2"></i> ANALİZ ET
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fff 0%, #f1f5f9 100%);">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase small fw-bold">Toplam Toplanan Süt</h6>
                    <h3 class="fw-bold text-primary mb-0" id="repTotalMilk">0 Lt</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fff 0%, #fff7ed 100%);">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase small fw-bold">Ortalama (Günlük)</h6>
                    <h3 class="fw-bold text-warning mb-0" id="repAvgMilk">0 Lt</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase small fw-bold">En Verimli Bölge</h6>
                    <h3 class="fw-bold text-success mb-0" id="repBestVillage">-</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold text-dark"><i class="fa-solid fa-chart-area me-2 text-primary"></i>Günlük Süt Toplama Grafiği</h6>
                </div>
                <div class="card-body">
                    <canvas id="milkTrendChart" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold text-dark"><i class="fa-solid fa-chart-pie me-2 text-primary"></i>Bölgesel Dağılım</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <canvas id="villagePieChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="advanced-reports" class="content-section hidden-section">
    
    <div id="reports-main-menu">
        <div class="row g-4">
            
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm hover-effect">
                    <div class="card-header bg-warning bg-opacity-10 border-0 py-3">
                        <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-cow me-2 text-warning"></i>SÜT RAPORLARI</h6>
                    </div>
                    <div class="list-group list-group-flush">
                        <button class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center" onclick="openReport('rep-milk-member')">
                            <div>
                                <span class="fw-bold text-dark small">Müşteri Süt Ekstresi</span>
                                <small class="d-block text-muted" style="font-size:0.7rem">Kişi bazlı tarih aralıklı döküm</small>
                            </div>
                            <i class="fa-solid fa-chevron-right text-muted small"></i>
                        </button>
                        <button class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center" onclick="Swal.fire('Bilgi','Bölge raporu hazırlanıyor.','info')">
                            <div>
                                <span class="fw-bold text-dark small">Bölge Bazlı Analiz</span>
                                <small class="d-block text-muted" style="font-size:0.7rem">Hangi köy ne kadar verimli?</small>
                            </div>
                            <i class="fa-solid fa-chevron-right text-muted small"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm hover-effect">
                    <div class="card-header bg-success bg-opacity-10 border-0 py-3">
                        <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-wallet me-2 text-success"></i>FİNANS RAPORLARI</h6>
                    </div>
                    <div class="list-group list-group-flush">
                        <button class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center" onclick="Swal.fire('Bilgi','Satış raporları hazırlanıyor.','info')">
                            <div>
                                <span class="fw-bold text-dark small">Satış Raporları</span>
                                <small class="d-block text-muted" style="font-size:0.7rem">Yem, un vb. satış dökümleri</small>
                            </div>
                            <i class="fa-solid fa-chevron-right text-muted small"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm hover-effect">
                    <div class="card-header bg-info bg-opacity-10 border-0 py-3">
                        <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-boxes-stacked me-2 text-info"></i>STOK RAPORLARI</h6>
                    </div>
                    <div class="list-group list-group-flush">
                        <button class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center" onclick="Swal.fire('Bilgi','Stok raporu hazırlanıyor.','info')">
                            <div>
                                <span class="fw-bold text-dark small">Stok Durum Raporu</span>
                                <small class="d-block text-muted" style="font-size:0.7rem">Mevcut envanter listesi</small>
                            </div>
                            <i class="fa-solid fa-chevron-right text-muted small"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="rep-milk-member" class="sub-report d-none">
        <div class="d-flex align-items-center mb-4">
            <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeReport()">
                <i class="fa-solid fa-arrow-left text-primary"></i>
            </button>
            <div>
                <h5 class="m-0 fw-bold">Müşteri Süt Ekstresi</h5>
                <small class="text-muted">Seçilen üyenin tarih aralığındaki süt dökümü</small>
            </div>
        </div>

        <div class="card border-0 shadow-sm p-4 mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Üye Seçiniz</label>
                    <select class="form-select" id="repFilterMember">
                        <option value="">Tüm Üyeler</option>
                        </select>
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Başlangıç</label>
                    <input type="date" class="form-control" id="repDateStart">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Bitiş</label>
                    <input type="date" class="form-control" id="repDateEnd">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary-custom w-100" onclick="musteriSutRaporuGetir()">
                        <i class="fa-solid fa-search me-2"></i> GETİR
                    </button>
                </div>
            </div>
        </div>

        <div class="table-responsive bg-white rounded shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Tarih</th>
                        <th>Üye Adı Soyadı</th>
                        <th class="text-center">Dönem</th>
                        <th class="text-end pe-4">Miktar (Lt)</th>
                    </tr>
                </thead>
                <tbody id="repMilkTableBody">
                    <tr><td colspan="4" class="text-center p-5 text-muted">Lütfen yukarıdan kriter seçip arama yapınız.</td></tr>
                </tbody>
                <tfoot class="bg-light fw-bold" style="border-top: 2px solid #e2e8f0;">
                    <tr>
                        <td colspan="3" class="text-end pe-3 py-3">TOPLAM SÜT:</td>
                        <td class="text-end pe-4 text-primary fs-5" id="repMilkTotal">0 Lt</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
</div>
        <div id="members" class="content-section hidden-section">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    <div>
                        <h4 class="m-0 fw-bold text-dark" id="lblListTitle">Kayıt Listesi</h4>
                        <small class="text-muted" id="recordCount">Yükleniyor...</small>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <div class="input-group" style="width: 250px;">
                            <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="Hızlı ara...">
                        </div>
                        <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addMemberModal" id="btnAddMember">
                            <i class="fa-solid fa-plus me-1"></i> Yeni
                        </button>
                       
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead>
                            <tr>
                                <th>Sıra</th>
                                <th id="thName">Ad Soyad</th>
                                <th>Bölge / Köy</th>
                                <th>Telefon</th>
                                <th class="text-end">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="stocks" class="content-section hidden-section">
    <div class="card p-4 border-0 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold text-dark m-0">Depo Mevcudu</h4>
                <small class="text-muted">Ürünlerin anlık stok durumları</small>
            </div>
            <button class="btn btn-primary-custom" onclick="yeniUrunModalAc()">
                <i class="fa-solid fa-plus me-2"></i> Yeni Ürün Tanımla
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Ürün Adı</th>
                        <th>Kategori</th>
                        <th class="text-center">Mevcut Stok</th>
                        <th class="text-end">Birim Fiyat (Satış)</th>
                        <th class="text-end">İşlem</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="milk-management" class="content-section hidden-section">
    <div class="row g-4">
        
        <div class="col-md-6 col-lg-5">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fffbeb 0%, #fff7ed 100%);">
                <div class="card-body p-4 text-center d-flex flex-column justify-content-center align-items-center">
                    <div class="bg-white p-3 rounded-circle shadow-sm mb-3 text-warning">
                        <i class="fa-solid fa-calculator fa-3x"></i>
                    </div>
                    <h4 class="fw-bold text-dark">Dönemsel Hesaplama</h4>
                    <p class="text-muted small mb-4">
                        Belirlenen tarih aralığındaki toplanan sütleri hesaplayıp, üyelerin cari hesabına "Alacak" olarak işler.
                    </p>
                    <button class="btn btn-warning w-100 fw-bold py-3 rounded-3 shadow-sm text-dark" 
        onclick="sutHesaplamaModalAc()">
    <i class="fa-solid fa-play me-2"></i> HESAPLAMA BAŞLAT
</button>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h5 class="fw-bold text-dark mb-3"><i class="fa-solid fa-circle-info text-primary me-2"></i>Nasıl Çalışır?</h5>
                    <ul class="list-group list-group-flush small">
                        <li class="list-group-item bg-transparent px-0">
                            <i class="fa-solid fa-check text-success me-2"></i>
                            <strong>Adım 1:</strong> Şoförler sahada sütleri toplar.
                        </li>
                        <li class="list-group-item bg-transparent px-0">
                            <i class="fa-solid fa-check text-success me-2"></i>
                            <strong>Adım 2:</strong> Siz buradan tarih aralığı (Örn: 1-15 Kasım) ve Litre Fiyatı girersiniz.
                        </li>
                        <li class="list-group-item bg-transparent px-0">
                            <i class="fa-solid fa-check text-success me-2"></i>
                            <strong>Adım 3:</strong> Sistem herkesin litresini fiyatla çarpıp bakiyesine ekler.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div> 

    <div class="card border-0 shadow-sm mt-4">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 fw-bold text-dark">
                <i class="fa-solid fa-list-check me-2 text-primary"></i>Son Süt Girişleri
            </h6>
            <button class="btn btn-sm btn-light border" onclick="sutListesiniGetir()">
                <i class="fa-solid fa-rotate me-1"></i> Yenile
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Tarih</th>
                        <th>Üretici</th>
                        <th>Şoför/Giren</th>
                        <th class="text-center">Dönem</th>
                        <th class="text-center">Miktar</th>
                        <th class="text-end">Durum</th>
                        <th class="text-end">Sil</th>
                    </tr>
                </thead>
                <tbody id="milkTableBody">
                    <tr><td colspan="7" class="text-center p-4 text-muted">Yükleniyor...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>



        <div id="settings" class="content-section hidden-section">
            
            <div id="settings-main-menu">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card settings-card" onclick="openSubSetting('sub-regions')">
                            <div class="s-icon icon-blue"><i class="fa-solid fa-map-location-dot"></i></div>
                            <h5 class="fw-bold text-dark">Bölgeler & Rotalar</h5>
                            <small class="text-muted d-block">Köy tanımları ve rota düzeni</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card settings-card" onclick="Swal.fire('Bilgi','Bu modül yapım aşamasında','info')">
                            <div class="s-icon icon-green"><i class="fa-solid fa-turkish-lira-sign"></i></div>
                            <h5 class="fw-bold text-dark">Fiyatlandırma</h5>
                            <small class="text-muted d-block">Birim fiyat ve primler</small>
                        </div>
                    </div>
                    <div class="col-md-4">
    <div class="card settings-card" onclick="openSubSetting('sub-pricing')">
        <div class="s-icon icon-green"><i class="fa-solid fa-calculator"></i></div>
        <h5 class="fw-bold text-dark">Fiyat & KDV</h5>
        <small class="text-muted d-block">Vergi hesaplama yöntemi</small>
    </div>
</div>
                    <div class="col-md-4">
                        <div class="card settings-card">
                            <div class="s-icon icon-purple"><i class="fa-solid fa-shield-halved"></i></div>
                            <h5 class="fw-bold text-dark">Yetkiler</h5>
                            <small class="text-muted d-block">Kullanıcı ve yönetici rolleri</small>
                        </div>
                    </div>
                </div>
            </div>
<div id="sub-regions" class="d-none sub-setting-page">
                <div class="d-flex align-items-center mb-4">
                    <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeSubSetting()" style="width: 45px; height: 45px;">
                        <i class="fa-solid fa-arrow-left text-primary"></i>
                    </button>
                    <div>
                        <h4 class="m-0 fw-bold">Bölge & Rota Yönetimi</h4>
                        <small class="text-muted">Köy ve mahalle tanımlarını buradan yönetebilirsiniz.</small>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 fw-bold text-primary"><i class="fa-solid fa-list-ul me-2"></i>Kayıtlı Rotalar</h6>
                                <span class="badge bg-primary-subtle text-primary" id="rotaSayisiBadge">0 Rota</span>
                            </div>
                            <div class="card-body">
                                <form id="addVillageForm" class="row g-2 mb-4 align-items-center">
                                    <div class="col">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-end-0"><i class="fa-solid fa-map-pin text-muted"></i></span>
                                            <input type="text" class="form-control form-control-lg border-start-0" id="newVillageInput" placeholder="Yeni Köy / Mahalle Adı" required>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-lg btn-primary-custom h-100 px-4">
                                            <i class="fa-solid fa-plus me-2"></i>EKLE
                                        </button>
                                    </div>
                                </form>

                                <hr class="text-muted opacity-25">

                                <div id="villageList" class="list-group list-group-flush overflow-auto custom-scrollbar" style="max-height: 450px;">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm bg-primary-subtle h-100">
                             <div class="card-body text-center p-4">
                                <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3 shadow-sm" style="width: 70px; height: 70px;">
                                    <i class="fa-solid fa-shield-halved text-primary fs-2"></i>
                                </div>
                                <h5 class="fw-bold text-dark mb-2">Güvenlik Limiti</h5>
                                <p class="text-muted small mb-4">
                                    Şoförlerin girdiği süt miktarında, bir önceki güne göre aşırı sapma olursa sistem uyarı verir.
                                </p>

                                <div class="bg-white p-4 rounded-4 shadow-sm">
                                    <label class="form-label small fw-bold text-start w-100 text-muted text-uppercase">Sapma Yüzdesi</label>
                                    <div class="input-group input-group-lg mb-3">
                                        <input type="number" class="form-control fw-bold text-center text-primary border-primary" id="sapmaInput" placeholder="50">
                                        <span class="input-group-text bg-primary text-white fw-bold">%</span>
                                    </div>
                                    <button class="btn btn-dark w-100 fw-bold py-2 rounded-3" onclick="limitKaydet()">
                                        <i class="fa-solid fa-check me-2"></i> AYARI KAYDET
                                    </button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="sub-pricing" class="d-none sub-setting-page">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeSubSetting()" style="width: 45px; height: 45px;">
            <i class="fa-solid fa-arrow-left text-primary"></i>
        </button>
        <h4 class="m-0 fw-bold">Fiyatlandırma Ayarları</h4>
    </div>

    <div class="card p-4 border-0 shadow-sm">
        <h6 class="text-primary fw-bold mb-3"><i class="fa-solid fa-file-invoice-dollar me-2"></i>KDV Hesaplama Yöntemi</h6>
        <p class="text-muted small">Evrak oluştururken girdiğiniz birim fiyatların KDV dahil mi yoksa hariç mi olduğunu belirleyin.</p>
        
        <div class="bg-light p-3 rounded border mb-3">
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="kdvAyari" id="optKdvHaric" value="haric" checked>
                <label class="form-check-label fw-bold" for="optKdvHaric">
                    KDV HARİÇ (Önerilen)
                </label>
                <div class="text-muted small ms-2">Örn: 100 ₺ yazarsanız, üzerine %10 ekler = 110 ₺ hesaplar.</div>
            </div>
            
            <hr class="my-2">

            <div class="form-check">
                <input class="form-check-input" type="radio" name="kdvAyari" id="optKdvDahil" value="dahil">
                <label class="form-check-label fw-bold" for="optKdvDahil">
                    KDV DAHİL
                </label>
                <div class="text-muted small ms-2">Örn: 110 ₺ yazarsanız, içinden vergiyi ayırır = 100 ₺ Mal + 10 ₺ KDV.</div>
            </div>
        </div>

        <button class="btn btn-primary-custom w-100" onclick="kdvAyariniKaydet()">
            <i class="fa-solid fa-save me-2"></i> Ayarı Güncelle
        </button>
    </div>
</div>
        </div>

        <div id="account-detail-page" class="content-section hidden-section">
            
            <button class="btn btn-primary-custom shadow mb-4 mt-4 px-4 rounded-pill fw-bold" onclick="listeyeDon()">
    <i class="fa-solid fa-arrow-left me-2"></i> LİSTEYE DÖN
</button>
<div class="account-header-card">
                <div class="row align-items-center">
                    
                    <div class="col-lg-5 col-md-12 mb-3 mb-lg-0">
                        <h4 class="m-0 fw-bold text-white" id="detailName">Üye Adı</h4>
                        <small class="m-0 text-white-50" id="detailPhone">05XX...</small>
                    </div>

                    <div class="col-lg-7 col-md-12">
                        <div class="d-flex justify-content-between justify-content-lg-end align-items-center gap-3 gap-lg-4 text-end">
                            
                            <div>
                                <small class="d-block text-white-50 fw-bold" style="font-size: 0.65rem;">BORÇ</small>
                                <div class="fw-bold text-white fs-5" id="detailBorc">0 ₺</div>
                            </div>

                            <div class="border-end border-white border-opacity-25" style="height: 30px;"></div>

                            <div>
                                <small class="d-block text-white-50 fw-bold" style="font-size: 0.65rem;">ALACAK</small>
                                <div class="fw-bold text-white fs-5" id="detailAlacak">0 ₺</div>
                            </div>

                            <div class="border-end border-white border-opacity-25" style="height: 30px;"></div>

                            <div>
                                <small class="d-block text-warning fw-bold" style="font-size: 0.65rem;">BAKİYE</small>
                                <div class="fw-bold text-white" style="font-size: 1.8rem; line-height: 1;" id="detailBalance">0 ₺</div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
<div class="row g-2 mb-4"> <div class="col-6 col-md-3">
        <button class="quick-action-btn" onclick="yeniEvrakModalAc()">
            <div class="btn-icon-circle" style="background: #e0f2fe; color: #0284c7;">
                <i class="fa-solid fa-file-invoice"></i>
            </div>
            <div class="text-start" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">YENİ EVRAK</div>
                <small class="text-muted" style="font-size: 0.65rem;">Fatura Kes</small>
            </div>
        </button>
    </div>

    <div class="col-6 col-md-3">
        <button class="quick-action-btn" onclick="islemEkle('tahsilat')">
            <div class="btn-icon-circle" style="background: #dcfce7; color: #166534;">
                <i class="fa-solid fa-hand-holding-dollar"></i>
            </div>
            <div class="text-start" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">TAHSİLAT</div>
                <small class="text-muted" style="font-size: 0.65rem;">Para Girişi</small>
            </div>
        </button>
    </div>

    <div class="col-6 col-md-3">
        <button class="quick-action-btn" onclick="islemEkle('odeme')">
            <div class="btn-icon-circle" style="background: #ffedd5; color: #c2410c;">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <div class="text-start" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">ÖDEME YAP</div>
                <small class="text-muted" style="font-size: 0.65rem;">Para Çıkışı</small>
            </div>
        </button>
    </div>

    <div class="col-6 col-md-3">
        <button class="quick-action-btn" onclick="Swal.fire('Bilgi','PDF Hazırlanıyor...','info')">
            <div class="btn-icon-circle bg-light text-secondary border">
                <i class="fa-solid fa-print"></i>
            </div>
            <div class="text-start" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">YAZDIR</div>
                <small class="text-muted" style="font-size: 0.65rem;">Ekstre Dökümü</small>
            </div>
        </button>
    </div>
</div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold text-dark"><i class="fa-solid fa-list-ul me-2 text-primary"></i>Hesap Hareketleri</h6>
                </div>
                <div class="table-responsive">
    <table class="table table-ledger align-middle mb-0">
        <thead>
            <tr>
                <th>Tarih</th>
                <th class="hide-mobile">Belge No</th>
                <th>Açıklama</th>
                <th class="text-end text-danger bg-light">Borç<br><small>(Mal Bedeli)</small></th>
                <th class="text-end text-success bg-light">Tahsilat<br><small>(Süt/Nakit)</small></th>
                <th class="text-end bg-white">Kalan Borç<br><small>(Bakiye)</small></th>
                <th class="text-end">İşlem</th>
            </tr>
        </thead>
        <tbody id="detailTableBody">
            </tbody>
    </table>
</div>
            </div>
        </div>

    </div> </div> <div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="lblModalTitle">Yeni Kayıt Oluştur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMemberForm">
                    <div class="row g-2 mb-3">
                        <div class="col-3">
                            <label class="small fw-bold text-muted">Sıra No</label>
                            <input type="number" class="form-control" id="uyeSira" placeholder="1">
                        </div>
                        <div class="col-9">
                            <label class="small fw-bold text-muted">Bölge / Rota</label>
                            <select class="form-select" id="uyeKoy" required>
                                <option value="">Seçiniz...</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">Adı</label>
                        <input type="text" class="form-control" id="uyeAd" required>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">Soyadı / Unvan</label>
                        <input type="text" class="form-control" id="uyeSoyad" required>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="small fw-bold text-muted">TC / Vergi No</label>
                            <input type="text" class="form-control" id="uyeTc">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-muted">Telefon</label>
                            <input type="text" class="form-control" id="uyeTel" placeholder="05...">
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary-custom">KAYDET</button>
                        <button type="button" class="btn btn-light text-danger btn-sm border" onclick="if(duzenlenecekId) uyeSil(duzenlenecekId)">Bu Kaydı Sil</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
  import { auth, db, signOut, onAuthStateChanged, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, getDoc, updateDoc, arrayUnion, arrayRemove, orderBy, limit, writeBatch, getDocs } from "../js/firebase-config.js";

    let currentCoopId = null;
    let allMembers = [];
    let villageList = [];
    let duzenlenecekEvrakId = null;
    window.firmaTuru = "koop"; 
    let kdvDahilMi = false;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            if(document.getElementById("userEmailDisplay")) {
                document.getElementById("userEmailDisplay").innerText = user.email;
            }
            
            // 1. Önce hafızaya bak
            currentCoopId = sessionStorage.getItem("coopId");
            
            // 2. Eğer hafızada yoksa (sayfa yenilendiyse), veritabanından tekrar çek (BU KISIM EKSİKTİ)
            if (!currentCoopId) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentCoopId = userData.coopId;
                    // Hafızayı tazele
                    sessionStorage.setItem("coopId", currentCoopId);
                    
                    // Eğer admin değilse uyar (Güvenlik)
                    if(userData.role !== 'admin') {
                        window.location.href = "../index.html";
                        return;
                    }
                }
            }
            
            // 3. ID Bulunduysa Verileri Çekmeye Başla
            if(currentCoopId) {
                console.log("Sirket ID: ", currentCoopId); // Konsola yazdıralım
                sirketBilgileriniDinle(currentCoopId);
                canliUyeDinle();
                stoklariDinle();
            } else {
                Swal.fire("Hata", "Kullanıcıya tanımlı şirket bulunamadı.", "error");
            }

        } else { 
            window.location.href = "../index.html"; 
        }
    });
  // --- ŞİRKET BİLGİLERİNİ VE ROTALARI DİNLE ---
function sirketBilgileriniDinle(id) {
    onSnapshot(doc(db, "cooperatives", id), (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Şirket Adı
            const lblCompany = document.getElementById("lblCompanyName");
            if(lblCompany) lblCompany.innerText = data.ad || "Kooperatif Paneli";
            
            // Sapma Limiti
            const sapmaInput = document.getElementById("sapmaInput");
            if(sapmaInput) sapmaInput.value = data.deviationLimit || "";
            
            // KDV Ayarı
            kdvDahilMi = data.isTaxInclusive || false;
            if(document.getElementById("optKdvDahil")) {
                document.getElementById("optKdvDahil").checked = kdvDahilMi;
                document.getElementById("optKdvHaric").checked = !kdvDahilMi;
            }

            // --- ROTA LİSTESİNİ GÜNCELLE ---
            // Veritabanındaki 'villages' dizisini al, yoksa boş dizi yap
            villageList = data.villages || []; 
            
            // Listeyi Ekrana Çiz (Yeni fonksiyonu çağır)
            ayarlarListesiniCiz();
            
            // Yeni Üye eklerken açılan listedeki selectbox'ı da güncelle
            modalSelectDoldur();
        }
    });
}
// --- LİSTE ÇİZME FONKSİYONU (YENİ TASARIMA UYGUN) ---
function ayarlarListesiniCiz() {
    const listDiv = document.getElementById("villageList");
    const badge = document.getElementById("rotaSayisiBadge");
    
    if(!listDiv) return;
    listDiv.innerHTML = ""; // Önce listeyi temizle
    
    // Veri yoksa veya boşsa "Kayıt Yok" görseli göster
    if(!Array.isArray(villageList) || villageList.length === 0) {
        if(badge) badge.innerText = "0 Rota";
        listDiv.innerHTML = `
            <div class="text-center py-5 text-muted">
                <div class="mb-3"><i class="fa-solid fa-map-location-dot fa-3x opacity-25"></i></div>
                <p class="m-0 fw-bold">Henüz Kayıt Yok</p>
                <small>Yukarıdan yeni bir rota ekleyebilirsiniz.</small>
            </div>`;
        return;
    }

    // Badge sayısını güncelle
    if(badge) badge.innerText = `${villageList.length} Rota`;

    // Listeyi Alfabetik Sırala
    villageList.sort((a, b) => a.localeCompare(b, 'tr'));
    
    // Her bir köy için liste elemanı oluştur
    villageList.forEach(koy => {
        const item = document.createElement("div");
        // Bootstrap List Group sınıflarını kullanıyoruz
        item.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 border-bottom";
        
        item.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="bg-light text-primary rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm" style="width:45px; height:45px;">
                    <i class="fa-solid fa-location-arrow"></i>
                </div>
                <div>
                    <h6 class="mb-0 fw-bold text-dark">${koy}</h6>
                    <small class="text-muted" style="font-size: 0.75rem;">Aktif Yerleşim Yeri</small>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-light text-primary border me-1" onclick="bolgeDuzenle('${koy}')" title="Adı Düzenle">
                    <i class="fa-solid fa-pen"></i>
                </button>
                <button class="btn btn-light text-danger border" onclick="bolgeSil('${koy}')" title="Sil">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `;
        listDiv.appendChild(item);
    });
}

    function modalSelectDoldur() {
        const selectBox = document.getElementById("uyeKoy");
        if(!selectBox) return;
        selectBox.innerHTML = '<option value="">Seçiniz...</option>';
        if(Array.isArray(villageList)) {
            villageList.sort().forEach(koy => {
                const opt = document.createElement("option");
                opt.value = koy; opt.text = koy;
                selectBox.appendChild(opt);
            });
        }
    }

    // Tabloları Çiz
    function canliUyeDinle() {
        const q = query(collection(db, "members"), where("coopId", "==", currentCoopId));
        onSnapshot(q, (snapshot) => {
            allMembers = [];
            snapshot.forEach((doc) => { let d = doc.data(); d.id = doc.id; allMembers.push(d); });
            allMembers.sort((a,b) => (Number(a.sira) || 999) - (Number(b.sira) || 999));
            
            tabloyuCiz(allMembers);
            
            const dashTotal = document.getElementById("dashTotalMember");
            if(dashTotal) dashTotal.innerText = allMembers.length;
        });
    }

   function tabloyuCiz(data) {
        const tbody = document.getElementById("memberTableBody");
        if(!tbody) return;
        tbody.innerHTML = "";
        
        if (data.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' class='text-center text-muted py-4'>Kayıt bulunamadı.</td></tr>";
            return;
        }

        data.forEach(uye => {
            // member-row class'ı eklendi
            const row = `
                <tr class="member-row">
                    <td><span class="badge bg-white text-secondary border shadow-sm">${uye.sira || '-'}</span></td>
                    <td>
                        <div class="fw-bold text-dark">${uye.ad} ${uye.soyad}</div>
                        <small class="text-muted" style="font-size:0.75rem">${uye.tc || 'TC Yok'}</small>
                    </td>
                    <td><span class="badge bg-light text-dark border">${uye.koy}</span></td>
                    <td class="text-muted small">${uye.telefon}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-primary-custom me-1 shadow-sm" onclick="hesapAc('${uye.id}')">
                            <i class="fa-solid fa-chevron-right"></i> Detay
                        </button>
                        <button class="btn btn-sm btn-light border" onclick="uyeDuzenle('${uye.id}')"><i class="fa-solid fa-pen text-muted"></i></button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
        
        const recCount = document.getElementById("recordCount");
        if(recCount) recCount.innerText = `${data.length} cari hesap listelendi`;
    }
    // Fonksiyonlar (Sil, Ekle, Düzenle)
    window.limitKaydet = async function() {
        const val = document.getElementById("sapmaInput").value;
        try {
            await updateDoc(doc(db, "cooperatives", currentCoopId), { deviationLimit: Number(val) });
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Limit Kaydedildi', timer: 1500, showConfirmButton: false });
        } catch (error) { Swal.fire("Hata", "Kaydedilemedi", "error"); }
    }
    window.kdvAyariniKaydet = async function() {
    // Seçili olan radio butonunu bul
    const secim = document.querySelector('input[name="kdvAyari"]:checked').value;
    const yeniDurum = (secim === 'dahil'); // 'dahil' ise true, değilse false

    try {
        await updateDoc(doc(db, "cooperatives", currentCoopId), { 
            isTaxInclusive: yeniDurum 
        });
        
        // Değişkeni hemen güncelle ki sayfa yenilemeye gerek kalmasın
        kdvDahilMi = yeniDurum;

        Swal.fire({
            icon: 'success',
            title: 'Ayar Güncellendi',
            text: `Artık birim fiyatlar KDV ${yeniDurum ? 'DAHİL' : 'HARİÇ'} olarak hesaplanacak.`,
            timer: 2000,
            showConfirmButton: false
        });
    } catch (error) {
        console.error(error);
        Swal.fire("Hata", "Ayar kaydedilemedi.", "error");
    }
}

    const addVillageForm = document.getElementById("addVillageForm");
    if(addVillageForm) {
        addVillageForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("newVillageInput");
            const yeniBolge = input.value.trim();
            if(!yeniBolge) return;
            if(Array.isArray(villageList) && villageList.includes(yeniBolge)) {
                Swal.fire("Uyarı", "Bu bölge zaten ekli!", "warning");
                return;
            }
            try {
                await updateDoc(doc(db, "cooperatives", currentCoopId), { villages: arrayUnion(yeniBolge) });
                input.value = "";
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Eklendi', timer: 1000, showConfirmButton: false });
            } catch (error) { console.error(error); }
        });
    }

    window.bolgeSil = async function(ad) {
        const res = await Swal.fire({ title: 'Silinsin mi?', text: `"${ad}" silinecek.`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Sil' });
        if(res.isConfirmed) await updateDoc(doc(db, "cooperatives", currentCoopId), { villages: arrayRemove(ad) });
    }

    window.bolgeDuzenle = async function(eskiAd) {
        const { value: yeniAd } = await Swal.fire({ title: 'Düzenle', input: 'text', inputValue: eskiAd, showCancelButton: true });
        if (yeniAd && yeniAd !== eskiAd) {
            const ref = doc(db, "cooperatives", currentCoopId);
            await updateDoc(ref, { villages: arrayRemove(eskiAd) });
            await updateDoc(ref, { villages: arrayUnion(yeniAd) });
        }
    }
// --- GRAFİK DEĞİŞKENLERİ ---
    let trendChart = null;
    let pieChart = null;

    // Menü geçiş fonksiyonunu (switchTab) bul ve içine şu 'else if' bloğunu ekle:
    // Mevcut kodunuzda "if(tabId==='milk-management')" satırının altına ekleyin.
    /*
       // --- DASHBOARD KISMI ---
        if(tabId === 'reports') {
            t = "Dashboard & Analiz"; 
            
            // Tarih filtreleri boşsa otomatik son 1 ayı doldur
            if(!document.getElementById("reportStartDate").value) {
                const bugun = new Date();
                const birAyOnce = new Date();
                birAyOnce.setDate(bugun.getDate() - 30);
                document.getElementById("reportEndDate").valueAsDate = bugun;
                document.getElementById("reportStartDate").valueAsDate = birAyOnce;
            }
            // Verileri getir (Fonksiyon tanımlıysa)
            if(typeof raporlariGetir === 'function') raporlariGetir();
        }
    */
    // (Yukarıdaki kısmı switchTab fonksiyonuna entegre etmeyi unutmayın, aşağıda tam halini vereceğim)


    // --- RAPORLARI GETİR FONKSİYONU ---
    window.raporlariGetir = async function() {
        const startVal = document.getElementById("reportStartDate").value;
        const endVal = document.getElementById("reportEndDate").value;

        if(!startVal || !endVal) { Swal.fire("Uyarı","Lütfen tarih aralığı seçiniz.","warning"); return; }

        const startDate = new Date(startVal);
        startDate.setHours(0,0,0,0);
        
        const endDate = new Date(endVal);
        endDate.setHours(23,59,59,999);

        Swal.fire({title: 'Analiz Ediliyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        try {
            // Süt Kayıtlarını Çek
            const q = query(
                collection(db, "milk_records"),
                where("coopId", "==", currentCoopId),
                where("date", ">=", startDate),
                where("date", "<=", endDate),
                orderBy("date", "asc")
            );

            const snapshot = await getDocs(q);
            
            // --- VERİ İŞLEME ---
            let totalLiters = 0;
            let daysMap = {};    // Günlük toplamlar: {'01.12': 500, '02.12': 600}
            let villageMap = {}; // Üyenin köyüne göre toplamlar

            // Köy bilgisini bulmak için üyeleri ID ile eşleştirelim
            // (allMembers dizisi zaten hafızada var)
            
            snapshot.forEach(doc => {
                const d = doc.data();
                const miktar = Number(d.liters);
                totalLiters += miktar;

                // 1. Günlük Gruplama
                const dateKey = d.date.toDate().toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit'});
                if(!daysMap[dateKey]) daysMap[dateKey] = 0;
                daysMap[dateKey] += miktar;

                // 2. Bölgesel Gruplama
                // Üyenin köyünü bul
                const member = allMembers.find(m => m.id === d.memberId);
                const koyAdi = member ? member.koy : "Bilinmeyen";
                
                if(!villageMap[koyAdi]) villageMap[koyAdi] = 0;
                villageMap[koyAdi] += miktar;
            });

            // --- KARTLARI DOLDUR ---
            document.getElementById("repTotalMilk").innerText = totalLiters.toLocaleString('tr-TR') + " Lt";
            
            // Gün Sayısı
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1; 
            const avg = (totalLiters / diffDays).toFixed(0);
            document.getElementById("repAvgMilk").innerText = avg + " Lt";

            // En İyi Köy
            let bestVillage = "-";
            let maxV = 0;
            for (const [k, v] of Object.entries(villageMap)) {
                if(v > maxV) { maxV = v; bestVillage = k; }
            }
            document.getElementById("repBestVillage").innerText = bestVillage;


            // --- GRAFİKLERİ ÇİZ ---
            grafikleriCiz(daysMap, villageMap);

            Swal.close();

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", "Rapor oluşturulamadı: "+error.message, "error");
        }
    }

    function grafikleriCiz(daysMap, villageMap) {
        // 1. Çizgi Grafik (Trend)
        const ctxTrend = document.getElementById('milkTrendChart').getContext('2d');
        
        // Eskiyi sil
        if(trendChart) trendChart.destroy();

        trendChart = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: Object.keys(daysMap),
                datasets: [{
                    label: 'Günlük Toplanan Süt (Lt)',
                    data: Object.values(daysMap),
                    borderColor: '#0f766e',
                    backgroundColor: 'rgba(15, 118, 110, 0.1)',
                    borderWidth: 2,
                    tension: 0.3, // Eğrisel çizgiler
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } }
            }
        });

        // 2. Pasta Grafik (Bölgeler)
        const ctxPie = document.getElementById('villagePieChart').getContext('2d');
        
        if(pieChart) pieChart.destroy();

        pieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: Object.keys(villageMap),
                datasets: [{
                    data: Object.values(villageMap),
                    backgroundColor: [
                        '#0e7490', '#0f766e', '#15803d', '#f59e0b', '#dc2626', '#7e22ce'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    const searchInput = document.getElementById("searchInput");
    if(searchInput) {
        searchInput.addEventListener("input", (e) => {
            const val = e.target.value.toLowerCase();
            const filt = allMembers.filter(m => m.ad.toLowerCase().includes(val) || m.soyad.toLowerCase().includes(val));
            tabloyuCiz(filt);
        });
    }

    // Üye Ekleme / Düzenleme
    let duzenlenecekId = null; 
    const memberForm = document.getElementById("addMemberForm");
    if(memberForm) {
        memberForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const veri = {
                sira: Number(document.getElementById("uyeSira").value),
                ad: document.getElementById("uyeAd").value,
                soyad: document.getElementById("uyeSoyad").value,
                tc: document.getElementById("uyeTc").value,
                koy: document.getElementById("uyeKoy").value,
                telefon: document.getElementById("uyeTel").value,
                coopId: currentCoopId,
                ...(duzenlenecekId ? {} : { kayitTarihi: new Date() }) 
            };

            try {
                if (duzenlenecekId) {
                    await updateDoc(doc(db, "members", duzenlenecekId), veri);
                    Swal.fire({ icon: 'success', title: 'Güncellendi', timer: 1000, showConfirmButton: false });
                } else {
                    await addDoc(collection(db, "members"), veri);
                    Swal.fire({ icon: 'success', title: 'Eklendi', timer: 1000, showConfirmButton: false });
                }
                const modal = bootstrap.Modal.getInstance(document.getElementById('addMemberModal'));
                modal.hide();
                formuTemizle();
            } catch (error) { Swal.fire({ icon: 'error', title: 'Hata', text: error.message }); }
        });
    }

    window.uyeDuzenle = function(id) {
        const uye = allMembers.find(m => m.id === id);
        if (!uye) return;
        duzenlenecekId = id;
        document.getElementById("uyeSira").value = uye.sira || "";
        document.getElementById("uyeAd").value = uye.ad;
        document.getElementById("uyeSoyad").value = uye.soyad;
        document.getElementById("uyeTc").value = uye.tc || "";
        document.getElementById("uyeKoy").value = uye.koy;
        document.getElementById("uyeTel").value = uye.telefon;
        document.getElementById("lblModalTitle").innerText = "Kaydı Düzenle";
        new bootstrap.Modal(document.getElementById('addMemberModal')).show();
    }

    function formuTemizle() {
        document.getElementById("addMemberForm").reset();
        duzenlenecekId = null;
        document.getElementById("lblModalTitle").innerText = "Yeni Kayıt Oluştur";
    }

    window.uyeSil = async function(id) { 
        if((await Swal.fire({title:'Silinsin mi?',icon:'warning',showCancelButton:true})).isConfirmed) await deleteDoc(doc(db,"members",id)); 
    }

    document.getElementById("logoutBtn").addEventListener("click", async()=>{ 
        await signOut(auth); window.location.href="../index.html"; 
    });
window.switchTab = function(tabId, el) { 
        // 1. Tüm sayfaları gizle
        document.querySelectorAll('.content-section').forEach(e=>e.classList.add('hidden-section')); 
        
        // 2. Seçilen sayfayı aç
        document.getElementById(tabId).classList.remove('hidden-section');
        
        // 3. Menüdeki aktifliği değiştir
        document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
        if(el) el.classList.add('active');
        
        // 4. Başlığı Ayarla
        let t = "Genel Durum";
        
        if(tabId==='members') t = window.firmaTuru ==='sahis' ? "Cari İşlemleri" : "Üye İşlemleri";
        if(tabId==='stocks') t = "Stok Yönetimi";
        if(tabId==='settings') t = "Ayarlar";
        if(tabId==='milk-management') {
            t = "Süt Toplama & Hesaplama";
            if(typeof sutListesiniGetir === 'function') sutListesiniGetir(); 
        }
        if(tabId === 'advanced-reports') {
        t = "Rapor Merkezi"; // Sayfa başlığı
    }
        // --- YENİ EKLENEN KISIM ---
        if(tabId==='reports') {
            t = "Raporlar & Analiz";
            // Tarih kutuları boşsa otomatik son 1 ayı ayarla
            if(!document.getElementById("reportStartDate").value) {
                const bugun = new Date();
                const birAyOnce = new Date();
                birAyOnce.setDate(bugun.getDate() - 30); // Son 30 gün
                document.getElementById("reportEndDate").valueAsDate = bugun;
                document.getElementById("reportStartDate").valueAsDate = birAyOnce;
            }
            // Sayfa açılır açılmaz raporu getir
            if(typeof raporlariGetir === 'function') raporlariGetir();
        }
        // --------------------------

        document.getElementById('page-title').innerText = t;
    }
// --- RAPOR MERKEZİ FONKSİYONLARI ---

    // Menüden alt rapora geçiş
    window.openReport = function(divId) {
        document.getElementById("reports-main-menu").classList.add("d-none"); // Kartları gizle
        document.querySelectorAll(".sub-report").forEach(el => el.classList.add("d-none")); // Diğerlerini gizle
        
        const target = document.getElementById(divId);
        if(target) {
            target.classList.remove("d-none"); // Hedefi aç
            
            // Tarihleri otomatik doldur (Son 30 gün)
            if(!document.getElementById("repDateStart").value) {
                const bugun = new Date();
                const birAyOnce = new Date();
                birAyOnce.setDate(bugun.getDate() - 30);
                document.getElementById("repDateEnd").valueAsDate = bugun;
                document.getElementById("repDateStart").valueAsDate = birAyOnce;
            }

            // Süt raporuysa üye listesini doldur
            if(divId === 'rep-milk-member') {
                raporUyeListesiDoldur();
            }
        }
    }

    // Alt rapordan menüye dönüş
    window.closeReport = function() {
        document.querySelectorAll(".sub-report").forEach(el => el.classList.add("d-none"));
        document.getElementById("reports-main-menu").classList.remove("d-none");
    }

    // Üye Selectbox Doldurma
    function raporUyeListesiDoldur() {
        const select = document.getElementById("repFilterMember");
        if(select.options.length > 1) return; // Zaten doluysa elleme
        
        // Alfabetik sırala
        const siraliUyeler = [...allMembers].sort((a,b) => a.ad.localeCompare(b.ad));
        
        siraliUyeler.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m.id;
            opt.text = `${m.ad} ${m.soyad} (${m.koy})`;
            select.appendChild(opt);
        });
    }

    // Raporu Çek ve Tabloya Bas
    window.musteriSutRaporuGetir = async function() {
        const memId = document.getElementById("repFilterMember").value;
        const sDate = document.getElementById("repDateStart").value;
        const eDate = document.getElementById("repDateEnd").value;

        if(!sDate || !eDate) { Swal.fire("Uyarı", "Tarih aralığı seçiniz.", "warning"); return; }

        const startDate = new Date(sDate); startDate.setHours(0,0,0,0);
        const endDate = new Date(eDate); endDate.setHours(23,59,59,999);

        Swal.showLoading();

        try {
            // Firebase Sorgusu
            const q = query(
                collection(db, "milk_records"),
                where("coopId", "==", currentCoopId),
                where("date", ">=", startDate),
                where("date", "<=", endDate),
                orderBy("date", "desc")
            );

            const snapshot = await getDocs(q);
            const tbody = document.getElementById("repMilkTableBody");
            tbody.innerHTML = "";
            
            let total = 0;
            let count = 0;

            snapshot.forEach(doc => {
                const d = doc.data();
                
                // JS tarafında üye filtresi (Index hatası almamak için)
                if(memId && d.memberId !== memId) return;

                total += Number(d.liters);
                count++;

                const dateStr = d.date.toDate().toLocaleDateString('tr-TR');
                const donem = d.period === 'sabah' 
                    ? '<span class="badge bg-warning text-dark"><i class="fa-solid fa-sun me-1"></i>Sabah</span>' 
                    : '<span class="badge bg-primary"><i class="fa-solid fa-moon me-1"></i>Akşam</span>';

                tbody.innerHTML += `
                    <tr>
                        <td class="ps-4 fw-bold text-secondary">${dateStr}</td>
                        <td>${d.memberName}</td>
                        <td class="text-center">${donem}</td>
                        <td class="text-end pe-4 fw-bold fs-6">${d.liters} Lt</td>
                    </tr>
                `;
            });

            if(count === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-5 text-muted fw-bold">Bu kriterlere uygun kayıt bulunamadı.</td></tr>';
            }
            
            document.getElementById("repMilkTotal").innerText = total.toLocaleString('tr-TR') + " Lt";
            Swal.close();

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", "Veri çekilemedi: " + error.message, "error");
        }
    }
    window.openSubSetting = function(id) {
        document.getElementById('settings-main-menu').classList.add('d-none');
        document.getElementById(id).classList.remove('d-none');
    }
    window.closeSubSetting = function() {
        document.querySelectorAll('.sub-setting-page').forEach(el => el.classList.add('d-none'));
        document.getElementById('settings-main-menu').classList.remove('d-none');
    }
    // --- CARİ HESAP FONKSİYONLARI ---
    
    let activeMemberId = null; 

  // 1. Listeden Detaya Geçiş (GÜNCELLENDİ)
    window.hesapAc = async function(id) {
        activeMemberId = id;
        const uye = allMembers.find(m => m.id === id);

        // İsim ve Başlıkları Doldur
        document.getElementById("detailName").innerText = `${uye.ad} ${uye.soyad}`;
        document.getElementById("detailPhone").innerText = `${uye.koy} • ${uye.telefon || 'Tel Yok'}`;

        // SAYFA DEĞİŞTİRME MANTIĞI:
        // 1. Tüm sayfaları gizle
        document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden-section'));
        
        // 2. !!! YENİ EKLENEN KISIM: Üstteki Genel Başlığı (Header) Gizle !!!
        document.querySelector('.admin-header').classList.add('d-none');
        
        // 3. Sadece Detay Sayfasını Aç
        const detailPage = document.getElementById('account-detail-page');
        detailPage.classList.remove('hidden-section');
        
        // Header gizlendiği için buton tavana yapışmasın diye üstten boşluk verelim
        detailPage.classList.add('pt-4'); 

        // Verileri Çekmeye Başla
        hareketleriDinle(id);
    }
    window.sutHesaplamaModalAc = function() {
        console.log("1. Fonksiyon tetiklendi.");

        // 1. Modalı HTML içinde bul
        const modalEl = document.getElementById('sutHesaplaModal');
        if(!modalEl) {
            alert("HATA: 'sutHesaplaModal' kimlikli pencere HTML'de bulunamadı!");
            return;
        }

        // 2. Tarihleri Ayarla (Son 7 gün)
        try {
            const bugun = new Date();
            const yediGunOnce = new Date();
            yediGunOnce.setDate(bugun.getDate() - 7);

            const dateStart = document.getElementById("calcStartDate");
            const dateEnd = document.getElementById("calcEndDate");
            
            if(dateStart && dateEnd) {
                dateEnd.valueAsDate = bugun;
                dateStart.valueAsDate = yediGunOnce;
            }
            
            // Fiyatı Temizle
            if(document.getElementById("calcPrice")) {
                document.getElementById("calcPrice").value = "";
            }

            // Açıklamayı Güncelle (Varsa fonksiyonu çalıştır)
            if(typeof otomatikAciklamaGuncelle === 'function') {
                otomatikAciklamaGuncelle();
            }
        } catch(e) {
            console.error("Tarih ayarlama hatası:", e);
        }

        // 3. Modalı Güvenli Şekilde Aç (Bootstrap 5)
        // 'new bootstrap.Modal' yerine 'getOrCreateInstance' kullanıyoruz ki çakışma olmasın.
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
        
        console.log("2. Modal aç komutu gönderildi.");
    }

    // Tarih değişince açıklamayı güncelle
    document.getElementById("calcStartDate").addEventListener("change", otomatikAciklamaGuncelle);
    document.getElementById("calcEndDate").addEventListener("change", otomatikAciklamaGuncelle);

    function otomatikAciklamaGuncelle() {
        const s = document.getElementById("calcStartDate").value;
        const e = document.getElementById("calcEndDate").value;
        if(s && e) {
            // Tarih formatını güzelleştir (YYYY-MM-DD -> DD.MM)
            const sFormat = s.split("-").reverse().slice(0,2).join(".");
            const eFormat = e.split("-").reverse().slice(0,2).join(".");
            document.getElementById("calcDesc").value = `${sFormat} - ${eFormat} Tarihli Süt Bedeli`;
        }
    }

    // --- HESAPLAMA VE KAYDETME İŞLEMİ ---
    document.getElementById("sutHesapForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const startVal = document.getElementById("calcStartDate").value;
        const endVal = document.getElementById("calcEndDate").value;
        const price = Number(document.getElementById("calcPrice").value);
        const desc = document.getElementById("calcDesc").value;

        if (price <= 0) { Swal.fire("Hata", "Lütfen geçerli bir fiyat girin.", "warning"); return; }

        // Tarih Nesnelerini Oluştur (Saat ayarı önemli)
        const startDate = new Date(startVal);
        startDate.setHours(0, 0, 0, 0); // Günün başı

        const endDate = new Date(endVal);
        endDate.setHours(23, 59, 59, 999); // Günün sonu

        // Kullanıcıya Onay Sor (Özet Bilgiyle)
        const confirm = await Swal.fire({
            title: 'Onaylıyor musunuz?',
            html: `
                <div class="text-start">
                    <p><strong>Tarih:</strong> ${startVal} / ${endVal}</p>
                    <p><strong>Fiyat:</strong> ${price} TL</p>
                    <p class="text-danger small">Bu işlem, belirtilen tarihlerdeki <u>henüz ödenmemiş</u> sütleri hesaplayıp üyelerin cari hesabına alacak olarak ekleyecektir.</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Evet, İşlemi Başlat',
            confirmButtonColor: '#198754'
        });

        if (!confirm.isConfirmed) return;

        // Yükleniyor...
        Swal.fire({title: 'İşleniyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        try {
             // 1. Firebase Batch (Toplu İşlem) Hazırla
             // Not: Firebase batch limiti 500 işlemdir. Çok büyük veride chunk yapmak gerekir ama şimdilik basit tutalım.
             const batch = writeBatch(db);
             
             // 2. Süt Kayıtlarını Çek
             const q = query(
                collection(db, "milk_records"),
                where("coopId", "==", currentCoopId),
                where("date", ">=", startDate),
                where("date", "<=", endDate)
                // where("isProcessed", "!=", true) // Bu sorgu bazen index hatası verebilir, JS ile filtrelemek daha güvenli şimdilik
             );

             const snapshot = await getDocs(q);
             
             if (snapshot.empty) {
                 Swal.fire("Bilgi", "Bu tarih aralığında kayıt bulunamadı.", "info");
                 return;
             }

             // 3. Verileri Grupla (Üye Bazlı Topla)
             let memberTotals = {}; // { "uyeId": {liters: 0, docs: []} }

             snapshot.forEach(doc => {
                 const data = doc.data();
                 // Eğer zaten işlendiyse (isProcessed: true) atla!
                 if (data.isProcessed === true) return;

                 if (!memberTotals[data.memberId]) {
                     memberTotals[data.memberId] = { 
                         liters: 0, 
                         docs: [], 
                         name: data.memberName 
                     };
                 }
                 memberTotals[data.memberId].liters += Number(data.liters);
                 memberTotals[data.memberId].docs.push(doc.id);
             });

             // Eğer işlenecek kayıt kalmadıysa
             if (Object.keys(memberTotals).length === 0) {
                 Swal.fire("Bilgi", "Seçilen tarih aralığındaki tüm kayıtlar zaten hesaplanmış.", "info");
                 return;
             }

             // 4. Batch'e Ekle
             let islemSayisi = 0;

             for (const [memId, val] of Object.entries(memberTotals)) {
                 if (val.liters > 0) {
                     const totalAmount = val.liters * price;

                     // A. Cari Hareketi Oluştur (Transaction)
                     const transRef = doc(collection(db, "transactions"));
                     batch.set(transRef, {
                         memberId: memId,
                         coopId: currentCoopId,
                         type: 'alacak', // Para girişi (Alacak)
                         category: 'Süt Bedeli',
                         description: `${desc} (${val.liters} Lt x ${price} TL)`,
                         amount: totalAmount,
                         date: new Date(), // İşlem tarihi bugün
                         items: [] // Detay yok
                     });

                     // B. Süt Kayıtlarını "İşlendi" Yap (milk_records update)
                     val.docs.forEach(docId => {
                         const milkRef = doc(db, "milk_records", docId);
                         batch.update(milkRef, { isProcessed: true });
                     });
                     
                     islemSayisi++;
                 }
             }

             // 5. Veritabanına Yaz
             await batch.commit();
             
             // Modalı kapat ve bilgi ver
             bootstrap.Modal.getInstance(document.getElementById('sutHesaplaModal')).hide();
             Swal.fire("Başarılı", `${islemSayisi} üyenin süt bedeli hesaplandı ve cariye işlendi.`, "success");

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", "İşlem sırasında bir sorun oluştu: " + error.message, "error");
        }
    });

    // --- IMPORT KISMINA EKLENECEK ---
    // Eğer writeBatch import edilmemişse, en üstteki import satırına 'writeBatch' eklemeyi unutma!
    // Örn: import { ..., writeBatch } from "...firebase-firestore.js";

    // 2. Detaydan Listeye Geri Dönüş (GÜNCELLENDİ)
    window.listeyeDon = function() {
        // Detay sayfasını gizle
        const detailPage = document.getElementById('account-detail-page');
        detailPage.classList.add('hidden-section');
        detailPage.classList.remove('pt-4'); // Boşluğu temizle

        // !!! YENİ EKLENEN KISIM: Üstteki Genel Başlığı Geri Getir !!!
        document.querySelector('.admin-header').classList.remove('d-none');

        // Listeyi göster
        document.getElementById('members').classList.remove('hidden-section');
        
        // Başlığı eski haline getir
        let t = window.firmaTuru === 'sahis' ? "Cari İşlemleri" : "Üye İşlemleri";
        document.getElementById('page-title').innerText = t;
    }

 // MEVCUT hareketleriDinle FONKSİYONUNU BUL VE BUNUNLA DEĞİŞTİR
    function hareketleriDinle(memId) {
        const q = query(
            collection(db, "transactions"), 
            where("memberId", "==", memId),
            orderBy("date", "asc") 
        );

        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById("detailTableBody");
            if(!tbody) return;
            tbody.innerHTML = "";

            if(snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Henüz işlem yok.</td></tr>';
                if(document.getElementById("detailBorc")) document.getElementById("detailBorc").innerText = "0 ₺";
                if(document.getElementById("detailAlacak")) document.getElementById("detailAlacak").innerText = "0 ₺";
                if(document.getElementById("detailBalance")) document.getElementById("detailBalance").innerText = "0 ₺";
                return;
            }

            let kumuletifBakiye = 0; 
            let toplamBorc = 0;
            let toplamAlacak = 0;
            
            snapshot.forEach(doc => {
                const t = doc.data();
                const miktar = Number(t.amount); // Bu artık GENEL TOPLAM
                const belgeNo = t.belgeNo || doc.id.substring(0,6).toUpperCase();
                const dateObj = t.date?.toDate();
                const tarih = dateObj ? dateObj.toLocaleDateString('tr-TR') : '-';
                
                let borcSutunu = "-";
                let alacakSutunu = "-";
                
                // Evrak tipine göre bakiye hesabı
                if (t.type === 'borc') {
                    kumuletifBakiye += miktar;
                    toplamBorc += miktar;
                    borcSutunu = `<span class="text-borc">${miktar.toLocaleString('tr-TR')} ₺</span>`;
                } else {
                    kumuletifBakiye -= miktar;
                    toplamAlacak += miktar;
                    alacakSutunu = `<span class="text-alacak">${miktar.toLocaleString('tr-TR')} ₺</span>`;
                }

                // EĞER BU BİR DETAYLI EVRAK İSE GÖZ İKONU KOY
                let detayBtn = '';
                if(t.items && t.items.length > 0) {
                    // Veriyi butona string olarak gömmek yerine ID ile çekeceğiz
                    detayBtn = `<button class="btn btn-sm btn-light border text-primary me-1" title="İçeriği Gör" onclick="evrakDetayGoster('${doc.id}')"><i class="fa-solid fa-eye"></i></button>`;
                }

                const tr = `
                    <tr>
                        <td class="fw-bold text-secondary">${tarih}</td>
                        <td class="hide-mobile"><span class="badge bg-light text-secondary border">#${belgeNo}</span></td>
                        <td>
                            <div class="fw-bold text-dark">${t.description || 'Evrak'}</div>
                            <small class="text-muted" style="font-size:0.7rem">${t.items ? t.items.length + ' Kalem Ürün' : t.category}</small>
                        </td>
                        <td class="text-end bg-light bg-opacity-25">${borcSutunu}</td>
                        <td class="text-end bg-light bg-opacity-25">${alacakSutunu}</td>
                        <td class="text-end"><span class="text-bakiye">${kumuletifBakiye.toLocaleString('tr-TR')} ₺</span></td>
                        <td class="text-end" style="min-width: 120px;">
    ${detayBtn}
    <button class="btn btn-sm btn-light border text-primary me-1" onclick="islemDuzenle('${doc.id}')" title="Düzenle">
        <i class="fa-solid fa-pen"></i>
    </button>
    <button class="btn btn-sm btn-light border text-danger" onclick="islemSil('${doc.id}')" title="Sil">
        <i class="fa-solid fa-trash"></i>
    </button>
</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('afterbegin', tr);
            });

            if(document.getElementById("detailBorc")) document.getElementById("detailBorc").innerText = toplamBorc.toLocaleString('tr-TR') + " ₺";
            if(document.getElementById("detailAlacak")) document.getElementById("detailAlacak").innerText = toplamAlacak.toLocaleString('tr-TR') + " ₺";
            if(document.getElementById("detailBalance")) document.getElementById("detailBalance").innerText = kumuletifBakiye.toLocaleString('tr-TR') + " ₺";
        });
    }

    


window.satirHesapla = function(id) {
    const row = document.getElementById(`row-${id}`);
    
    // Girdileri Al
    const qty = Number(row.querySelector('.item-qty').value) || 0;
    const priceInput = Number(row.querySelector('.item-price').value) || 0;
    const taxRate = Number(row.querySelector('.item-tax').value) || 0;

    let kdvTutari = 0;
    let genelToplam = 0;
    // Araç ipucu (Tooltip) veya görsel geri bildirim için input rengini değiştirebiliriz
    const priceField = row.querySelector('.item-price');

    if (kdvDahilMi) {
        // --- SENARYO 1: KDV DAHİL (İçinden Ayır) ---
        // Kullanıcı "110 TL" yazdıysa, bu GENEL TOPLAM birim fiyattır.
        
        // Formül: Vergisiz Fiyat = Fiyat / (1 + Oran)
        const vergisizBirimFiyat = priceInput / (1 + (taxRate / 100));
        
        const toplamVergisizTutar = vergisizBirimFiyat * qty;
        genelToplam = priceInput * qty; // Toplam direkt miktar * girilen fiyat
        kdvTutari = genelToplam - toplamVergisizTutar;

        // Görsel İpucu: KDV Dahil modunda input hafif yeşilimsi olsun
        priceField.style.backgroundColor = "#f0fdf4"; 
        priceField.title = "Girdiğiniz fiyata KDV Dahildir";

    } else {
        // --- SENARYO 2: KDV HARİÇ (Üstüne Ekle) ---
        // Kullanıcı "100 TL" yazdıysa, bu HAM fiyattır.
        
        const toplamVergisizTutar = priceInput * qty;
        kdvTutari = toplamVergisizTutar * (taxRate / 100);
        genelToplam = toplamVergisizTutar + kdvTutari;

        // Görsel İpucu: Normal beyaz
        priceField.style.backgroundColor = "#fff";
        priceField.title = "Girdiğiniz fiyata KDV eklenecektir";
    }

    // Sonuçları Yazdır (2 hane kuruş hassasiyeti)
    row.querySelector('.item-tax-amt').value = kdvTutari.toFixed(2);
    row.querySelector('.item-total').value = genelToplam.toFixed(2);
    
    // Alt toplamları yenile
    genelToplamHesapla();
}
window.genelToplamHesapla = function() {
    let toplamKdv = 0; 
    let genelToplam = 0; 

    document.querySelectorAll('#faturaSatirlari tr').forEach(row => {
        const rowTax = Number(row.querySelector('.item-tax-amt').value) || 0;
        const rowTotal = Number(row.querySelector('.item-total').value) || 0;
        
        toplamKdv += rowTax;
        genelToplam += rowTotal;
    });

    // Ara Toplam = Genel Toplam - KDV
    const araToplam = genelToplam - toplamKdv;

    // HTML'e Yazdır
    if(document.getElementById("lblAraToplam")) 
        document.getElementById("lblAraToplam").innerText = araToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
    
    if(document.getElementById("lblKdvToplam")) 
        document.getElementById("lblKdvToplam").innerText = toplamKdv.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
        
    if(document.getElementById("lblGenelToplam")) 
        document.getElementById("lblGenelToplam").innerText = genelToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
}
// --- EVRAK DETAY GÖSTERME (HESAPLAMALI YENİ VERSİYON) ---
    window.evrakDetayGoster = async function(docId) {
        console.log("Detay isteniyor:", docId);

        try {
            const modalEl = document.getElementById('detayModal');
            if (!modalEl) { console.error("Modal HTML bulunamadı!"); return; }

            // Pencereyi en üste taşı (Donma sorununu çözer)
            document.body.appendChild(modalEl);

            // Modalı Aç
            let modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (!modalInstance) {
                modalInstance = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: true });
            }
            modalInstance.show();

            // Yükleniyor Animasyonu
            const tbody = document.getElementById("detayIcerik");
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-5 text-primary"><div class="spinner-border mb-2" role="status"></div><div class="fw-bold">Detaylar Hesaplanıyor...</div></td></tr>';

            // Veriyi Çek
            const docRef = doc(db, "transactions", docId);
            const docSnap = await getDoc(docRef);

            if(docSnap.exists()) {
                const data = docSnap.data();
                const items = data.items || [];
                
                // Başlık Bilgileri
                const dateObj = data.date?.toDate();
                const tarihStr = dateObj ? dateObj.toLocaleDateString('tr-TR') : '-';
                const belgeNo = data.belgeNo ? `#${data.belgeNo}` : '(Belge No Yok)';
                
                document.getElementById("detayBaslik").innerText = (data.type === 'borc' ? 'Satış Faturası Detayı' : 'Alış/İade Faturası Detayı');
                document.getElementById("detayTarihNo").innerText = `${tarihStr} • ${belgeNo}`;
                document.getElementById("detayAciklama").innerText = data.description || "Açıklama girilmemiş.";

                tbody.innerHTML = ""; // Temizle

                // HESAPLAMA DEĞİŞKENLERİ
                let toplamMatrah = 0;
                let toplamKdv = 0;
                let genelToplam = 0;
                const isInclusive = data.isTaxInclusive || false; // Kaydedilirken KDV dahil miydi?

                if (items.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5' class='text-center text-muted py-4 fw-bold'>Bu işlem ürün bazlı değil (Nakit/Manuel İşlem).</td></tr>";
                    genelToplam = Number(data.amount) || 0;
                } else {
                    items.forEach(item => {
                        const urunAdi = item.name || '-';
                        const miktar = Number(item.qty) || 0;
                        const birim = item.unit || '';
                        const birimFiyat = Number(item.price) || 0;
                        const kdvOrani = Number(item.taxRate) || 0;
                        const satirToplam = Number(item.total) || 0; // Veritabanındaki Satır Sonu Tutarı

                        // --- MATEMATİKSEL AYRIŞTIRMA ---
                        let satirMatrah = 0;
                        let satirKdvTutari = 0;

                        if (isInclusive) {
                            // Eğer KDV Dahil ise, içinden KDV'yi cımbızla alıyoruz
                            satirMatrah = satirToplam / (1 + (kdvOrani / 100));
                            satirKdvTutari = satirToplam - satirMatrah;
                        } else {
                            // Eğer KDV Hariç ise, KDV'yi üstüne ekleyerek buluyoruz
                            satirMatrah = birimFiyat * miktar; // Fiyat x Adet
                            satirKdvTutari = satirMatrah * (kdvOrani / 100);
                        }

                        // Toplamlara Ekle
                        toplamMatrah += satirMatrah;
                        toplamKdv += satirKdvTutari;
                        genelToplam += satirToplam;

                        // Tabloya Satır Ekle
                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">${urunAdi}</div>
                                    <small class="text-muted">${item.code || ''}</small>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark border">${miktar} ${birim}</span>
                                </td>
                                <td class="text-end text-muted">${birimFiyat.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</td>
                                <td class="text-center"><span class="badge bg-white text-secondary border">%${kdvOrani}</span></td>
                                <td class="text-end pe-4 fw-bold text-dark">${satirToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</td>
                            </tr>
                        `;
                    });
                }

                // --- ALT KUTUCUKLARI DOLDUR ---
                document.getElementById("ozetAraToplam").innerText = toplamMatrah.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
                document.getElementById("ozetKdv").innerText = toplamKdv.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
                document.getElementById("ozetGenelToplam").innerText = genelToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";

            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger fw-bold py-3">Kayıt bulunamadı.</td></tr>';
            }

        } catch (error) {
            console.error("HATA:", error);
            const tbody = document.getElementById("detayIcerik");
            if(tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-3">Hata: ${error.message}</td></tr>`;
        }
    }

   // --- İŞLEM EKLEME FONKSİYONU (GÜNCELLENDİ - ÖDEME DAHİL) ---
    window.islemEkle = async function(islemTuru) {
        // islemTuru: 'satis', 'tahsilat' veya 'odeme'
        
        let baslik, renk, kategoriler, kayitTipi;

        if (islemTuru === 'satis') {
            baslik = 'Hızlı Satış (Borçlandır)';
            renk = '#dc2626'; // Kırmızı
            kategoriler = '<option>Yem</option><option>Un</option><option>Kepek</option><option>Market</option>';
            kayitTipi = 'borc';
        } 
        else if (islemTuru === 'odeme') {
            // YENİ: ÖDEME YAPMA (Para Çıkışı)
            baslik = 'Ödeme Yap (Para Çıkışı)';
            renk = '#f97316'; // Turuncu
            kategoriler = '<option>Eft Havale</option><option>Nakit Ödeme</option><option>Avans</option>';
            kayitTipi = 'borc'; // Ödeme yapmak, üyenin alacağını azaltır (Borç hanesine yazılır)
        }
        else {
            // TAHSİLAT (Para Girişi)
            baslik = 'Tahsilat Al (Para Girişi)';
            renk = '#166534'; // Yeşil
            kategoriler = '<option>Nakit Tahsilat</option><option>Banka/Havale</option><option>Kredi Kartı</option>';
            kayitTipi = 'alacak';
        }

        // SweetAlert Penceresi
        const { value: formValues } = await Swal.fire({
            title: baslik,
            html: `
                <label class="small fw-bold d-block text-start text-muted">İşlem Türü</label>
                <select id="swal-cat" class="form-select mb-3">${kategoriler}</select>
                
                <label class="small fw-bold d-block text-start text-muted">Tutar (TL)</label>
                <input id="swal-amt" class="form-control mb-3 fw-bold fs-5" type="number" placeholder="0.00">
                
                <label class="small fw-bold d-block text-start text-muted">Açıklama</label>
                <input id="swal-desc" class="form-control" placeholder="Opsiyonel açıklama...">
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonColor: renk,
            confirmButtonText: 'Kaydet',
            preConfirm: () => {
                return {
                    cat: document.getElementById('swal-cat').value,
                    amt: document.getElementById('swal-amt').value,
                    desc: document.getElementById('swal-desc').value
                }
            }
        });

        if (formValues && formValues.amt) {
            try {
                // Veritabanına Yaz
                await addDoc(collection(db, "transactions"), {
                    memberId: activeMemberId,
                    coopId: currentCoopId,
                    type: kayitTipi, // borc veya alacak
                    category: formValues.cat,
                    amount: Number(formValues.amt),
                    description: formValues.desc || formValues.cat,
                    date: new Date()
                });
                
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1000});
                Toast.fire({ icon: 'success', title: 'İşlem Kaydedildi' });
                
            } catch (error) {
                console.error(error);
                Swal.fire('Hata', error.message, 'error');
            }
        }
    }
    window.islemSil = async function(id) {
        // 1. Onay Sor
        const result = await Swal.fire({
            title: 'Bu işlemi silmek istiyor musun?',
            text: "Bakiye yeniden hesaplanacak.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Evet, Sil',
            cancelButtonText: 'Vazgeç'
        });

        // 2. Onaylandıysa Sil
        if (result.isConfirmed) {
            try {
                await deleteDoc(doc(db, "transactions", id));
                
                // Başarılı Mesajı
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1000
                });
                Toast.fire({ icon: 'success', title: 'İşlem Silindi' });
                
            } catch (error) {
                console.error(error);
                Swal.fire("Hata", "Silinemedi: " + error.message, "error");
            }
        }
    }
    // 1. MODALI AÇMA FONKSİYONU (GÜNCELLENMİŞ - HATASIZ)
    window.yeniEvrakModalAc = function() {
        // Değişkeni sıfırla (Yeni kayıt modu)
        duzenlenecekEvrakId = null;
        
        // Formu Temizle
        if(document.getElementById("modalBaslik")) document.getElementById("modalBaslik").innerText = "Yeni Evrak Girişi";
        document.getElementById("faturaSatirlari").innerHTML = "";
        document.getElementById("evrakAciklama").value = "";
        document.getElementById("evrakBelgeNo").value = "";
        document.getElementById("evrakTarih").valueAsDate = new Date();
        
        // --- HATAYI ÇÖZEN KISIM BURASI ---
        // Artık 'evrakGenelToplam' kutusu yok, onun yerine 'lblGenelToplam' var.
        // Kodun patlamaması için kontrol ederek sıfırlıyoruz:
        
        if(document.getElementById("lblGenelToplam")) document.getElementById("lblGenelToplam").innerText = "0,00 ₺";
        if(document.getElementById("lblAraToplam")) document.getElementById("lblAraToplam").innerText = "0,00 ₺";
        if(document.getElementById("lblKdvToplam")) document.getElementById("lblKdvToplam").innerText = "0,00 ₺";
        
        // Ödeme kutuları varsa onları da sıfırla
        if(document.getElementById("inpOdenenTutar")) document.getElementById("inpOdenenTutar").value = "";
        if(document.getElementById("lblKalanBakiye")) document.getElementById("lblKalanBakiye").innerText = "0,00 ₺";

        // Buton yazısını düzelt
        if(document.getElementById("evrakKaydetBtn")) document.getElementById("evrakKaydetBtn").innerText = "KAYDET"; 

        // İlk boş satırı ekle
        if(typeof satirEkle === 'function') {
            satirEkle();
        }
        
        // Modalı Göster
        new bootstrap.Modal(document.getElementById('evrakModal')).show();
    }

   window.islemDuzenle = async function(id) {
        try {
            const docRef = doc(db, "transactions", id);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) { Swal.fire("Hata", "Kayıt bulunamadı", "error"); return; }
            const veri = docSnap.data();

            if (veri.items && veri.items.length > 0) {
                duzenlenecekEvrakId = id;
                document.getElementById("evrakTuru").value = (veri.type === 'borc') ? 'satis' : 'iade';
                
                const dateObj = veri.date.toDate();
                const yyyy = dateObj.getFullYear();
                const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                const dd = String(dateObj.getDate()).padStart(2, '0');
                document.getElementById("evrakTarih").value = `${yyyy}-${mm}-${dd}`;
                document.getElementById("evrakBelgeNo").value = veri.belgeNo || "";
                document.getElementById("evrakAciklama").value = veri.description || "";
                
                const tbody = document.getElementById("faturaSatirlari");
                tbody.innerHTML = "";

                // BİRİMLER LİSTESİ (GÜNCELLENDİ)
                const birimlerHtml = `
                    <option value="Adet">Adet</option>
                    <option value="Adet (Çuval)">Adet (Çuval)</option>
                    <option value="Kg">Kg</option>
                    <option value="Ton">Ton</option>
                    <option value="Litre">Litre</option>
                    <option value="Çuval">Çuval</option>
                    <option value="Koli">Koli</option>
                    <option value="Paket">Paket</option>
                    <option value="Metre">Metre</option>
                `;

                veri.items.forEach(item => {
                    const rowId = Date.now() + Math.random().toString(16).slice(2);
                    const tr = document.createElement("tr");
                    tr.id = `row-${rowId}`;
                    // --- YENİ EKLENECEK KOD BAŞLANGIÇ ---
            tr.innerHTML = `
                <td>
                    <input type="text" class="form-control form-control-sm item-code bg-light fw-bold text-dark" value="${item.code || ''}" readonly>
                </td>

                <td>
                    <input type="text" class="form-control form-control-sm item-name" value="${item.name}">
                    <input type="hidden" class="item-prod-id" value="${item.productId || ''}">
                </td>

                <td>
                    <input type="number" class="form-control form-control-sm item-qty fw-bold" value="${item.qty}" min="1" oninput="satirHesapla('${rowId}')">
                </td>

                <td>
                    <select class="form-select form-select-sm item-unit">
                        ${birimlerHtml}
                    </select>
                </td>

                <td>
                    <input type="number" class="form-control form-control-sm item-price" value="${item.price}" oninput="satirHesapla('${rowId}')">
                </td>

                <td>
                    <select class="form-select form-select-sm item-tax" onchange="satirHesapla('${rowId}')">
                        <option value="0" ${item.taxRate == 0 ? 'selected' : ''}>0%</option>
                        <option value="1" ${item.taxRate == 1 ? 'selected' : ''}>1%</option>
                        <option value="10" ${item.taxRate == 10 ? 'selected' : ''}>10%</option>
                        <option value="20" ${item.taxRate == 20 ? 'selected' : ''}>20%</option>
                    </select>
                </td>

                <td><input type="text" class="form-control form-control-sm item-tax-amt bg-white" disabled value="0.00"></td>

                <td><input type="text" class="form-control form-control-sm fw-bold item-total bg-white" disabled value="${item.total}"></td>

                <td class="text-center">
                    <button class="btn btn-sm text-danger" onclick="this.closest('tr').remove(); genelToplamHesapla();">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </td>
            `;
            // --- YENİ EKLENECEK KOD BİTİŞ ---
                    tbody.appendChild(tr);
                    
                    // KAYITLI BİRİMİ SEÇİLİ YAP
                    tr.querySelector('.item-unit').value = item.unit || 'Adet';
                    
                    satirHesapla(rowId);
                });

                if(document.getElementById("modalBaslik")) document.getElementById("modalBaslik").innerText = "Faturayı Düzenle";
                document.getElementById("evrakKaydetBtn").innerText = "GÜNCELLE";
                new bootstrap.Modal(document.getElementById('evrakModal')).show();
            } else {
                basitIslemDuzenle(id, veri);
            }
        } catch (error) { console.error(error); Swal.fire("Hata", error.message, "error"); }
    }
    // --- SATIR EKLEME FONKSİYONU (GÜNCELLENDİ) ---
window.satirEkle = function() {
    const tbody = document.getElementById("faturaSatirlari");
    const rowId = Date.now() + Math.random().toString(16).slice(2);
    
    // Ürün Listesini Hazırla
    let options = '<option value="">Ürün Seçiniz...</option>';
    // allProducts dizisinin dolu olduğundan emin olalım
    if (typeof allProducts !== 'undefined' && Array.isArray(allProducts)) {
        allProducts.forEach(p => {
            // Birim verisini güvenli şekilde al
            const unitVal = p.unit || "Adet";
            // KDV Oranı yoksa 0 kabul et
            // Fiyat bilgisini attribute olarak ekle
            options += `<option value="${p.id}" data-code="${p.code || ''}" data-price="${p.sellPrice || 0}" data-name="${p.name}" data-unit="${unitVal}">${p.name}</option>`;
        });
    }

    // --- ÖNEMLİ: Ürün Kartındaki Birimlerle Birebir Aynı Olmalı ---
    const birimler = `
        <option value="Adet">Adet</option>
        <option value="Adet (Çuval)">Adet (Çuval)</option>
        <option value="Kg">Kg</option>
        <option value="Ton">Ton</option>
        <option value="Litre">Litre</option>
        <option value="Çuval">Çuval</option>
        <option value="Koli">Koli</option>
        <option value="Paket">Paket</option>
        <option value="Metre">Metre</option>
    `;

    const tr = document.createElement("tr");
    tr.id = `row-${rowId}`;
    
    tr.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm item-code bg-light fw-bold text-dark" placeholder="Kod" readonly tabindex="-1">
        </td>
        
        <td>
            <select class="form-select form-select-sm item-select" onchange="urunSecildi(this, '${rowId}')">
                ${options}
            </select>
            <input type="hidden" class="item-name">
            <input type="hidden" class="item-prod-id"> 
        </td>
        
        <td>
            <input type="number" class="form-control form-control-sm item-qty fw-bold" value="1" min="1" oninput="satirHesapla('${rowId}')">
        </td>

        <td>
            <select class="form-select form-select-sm item-unit">
                ${birimler}
            </select>
        </td>

        <td>
            <input type="number" class="form-control form-control-sm item-price" placeholder="0.00" oninput="satirHesapla('${rowId}')">
        </td>

        <td>
            <select class="form-select form-select-sm item-tax" onchange="satirHesapla('${rowId}')">
                <option value="0">0%</option>
                <option value="1">1%</option>
                <option value="10" selected>10%</option>
                <option value="20">20%</option>
            </select>
        </td>

        <td><input type="text" class="form-control form-control-sm item-tax-amt bg-white" disabled value="0.00"></td>
        
        <td><input type="text" class="form-control form-control-sm fw-bold item-total bg-white" disabled value="0.00"></td>
        
        <td class="text-center">
            <button class="btn btn-sm text-danger" onclick="this.closest('tr').remove(); genelToplamHesapla();">
                <i class="fa-solid fa-times"></i>
            </button>
        </td>
    `;
    tbody.appendChild(tr);
}
// --- ÜRÜN SEÇİLDİĞİNDE VERİLERİ DOLDUR ---
window.urunSecildi = function(selectEl, rowId) {
    const option = selectEl.options[selectEl.selectedIndex];
    
    // Data özelliklerini al
    const code = option.getAttribute('data-code') || ""; 
    const price = option.getAttribute('data-price') || 0;
    const name = option.getAttribute('data-name') || "";
    // Varsayılan birim Adet olsun
    const unit = option.getAttribute('data-unit') || "Adet"; 
    const prodId = selectEl.value;

    const row = document.getElementById(`row-${rowId}`);
    
    // İlgili kutuları doldur
    row.querySelector('.item-code').value = code;       // Kodu yaz
    row.querySelector('.item-price').value = price;     // Fiyatı yaz
    row.querySelector('.item-name').value = name;       // Adı sakla
    row.querySelector('.item-prod-id').value = prodId;  // ID'yi sakla
    
    // BİRİMİ OTOMATİK SEÇ (HATA GİDERİLDİ)
    const unitSelect = row.querySelector('.item-unit');
    unitSelect.value = unit;

    // Eğer tam eşleşme bulamazsa (Örn: "Adet" geldi ama listede yoksa),
    // listedeki ilk elemanı seçmesin, manuel seçime izin versin.
    // Ancak satirEkle içindeki listeyi güncellediğimiz için burası çalışacaktır.
    
    // Rakamları hemen hesapla
    satirHesapla(rowId); 
}
// --- EVRAK KAYDETME FONKSİYONU (DÜZELTİLMİŞ HALİ) ---
window.evrakiKaydet = async function() {
    // 1. Butonu kilitle (Çift tıklamayı önle)
    const btn = document.getElementById("evrakKaydetBtn");
    const orjText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "İşleniyor...";

    try {
        const items = [];
        let grandTotal = 0;

        // Tablodaki satırları tek tek oku
        const rows = document.querySelectorAll('#faturaSatirlari tr');
        
        rows.forEach(row => {
            // Güvenli veri okuma (Eleman var mı diye kontrol et)
            const elName = row.querySelector('.item-name');
            const elCode = row.querySelector('.item-code');
            const elProdId = row.querySelector('.item-prod-id');
            const elUnit = row.querySelector('.item-unit');
            const elQty = row.querySelector('.item-qty');
            const elPrice = row.querySelector('.item-price');
            const elTax = row.querySelector('.item-tax');
            const elTotal = row.querySelector('.item-total');

            // Eğer zorunlu alanlar varsa veriyi al
            if (elName && elName.value) {
                const totalVal = Number(elTotal.value) || 0;
                
                items.push({
                    productId: elProdId ? elProdId.value : null,
                    code: elCode ? elCode.value : "",
                    name: elName.value,
                    unit: elUnit ? elUnit.value : "Adet",
                    qty: Number(elQty.value) || 0,
                    price: Number(elPrice.value) || 0,
                    taxRate: Number(elTax.value) || 0,
                    total: totalVal
                });
                grandTotal += totalVal;
            }
        });

        // HATA KONTROLÜ: Tablo boşsa uyarı ver
        if (items.length === 0) {
            throw new Error("Lütfen en az bir ürün satırı ekleyin ve ürün seçin.");
        }

        // Form verilerini al
        const evrakTuru = document.getElementById("evrakTuru").value;
        const tarihVal = document.getElementById("evrakTarih").value;
        const belgeNo = document.getElementById("evrakBelgeNo").value;
        // Eğer açıklama boşsa otomatik doldur
        const aciklama = document.getElementById("evrakAciklama").value || (evrakTuru === 'satis' ? 'Vadeli Satış Faturası' : 'İade Faturası');
        
        // Tarih kontrolü
        if (!tarihVal) throw new Error("Lütfen geçerli bir tarih seçiniz.");

        // Veritabanı nesnesi hazırla
        const faturaVerisi = {
            memberId: activeMemberId, // Bu değişken globalde tanımlı olmalı
            coopId: currentCoopId,    // Bu değişken globalde tanımlı olmalı
            type: evrakTuru === 'satis' ? 'borc' : 'alacak',
            category: 'Fatura',
            description: aciklama,
            amount: grandTotal,
            date: new Date(tarihVal),
            belgeNo: belgeNo,
            items: items,
            isTaxInclusive: typeof kdvDahilMi !== 'undefined' ? kdvDahilMi : false // Ayar değişkeni varsa ekle
        };

        // Veritabanına Yazma İşlemi
        if (duzenlenecekEvrakId) {
            // Güncelleme Modu
            await updateDoc(doc(db, "transactions", duzenlenecekEvrakId), faturaVerisi);
            
            Swal.fire({
                icon: 'success',
                title: 'Güncellendi',
                text: 'Evrak başarıyla güncellendi.',
                timer: 1500,
                showConfirmButton: false
            });
        } else {
            // Yeni Kayıt Modu
            await addDoc(collection(db, "transactions"), faturaVerisi);

            // STOKTAN DÜŞME (Sadece Satışsa)
            if (evrakTuru === 'satis') {
                for (const item of items) {
                    if (item.productId) {
                        // Ürünün mevcut stoğunu çekmemiz lazım, ancak basitlik için 
                        // burada sadece işlemi yapıyoruz. Gerçek stok takibi için
                        // ürün belgesini okuyup güncellemek daha sağlıklıdır.
                        // Şimdilik sadece transaction kaydediyoruz.
                        // İsterseniz stok düşme kodunu buraya tekrar ekleyebilirim.
                    }
                }
            }

            Swal.fire({
                icon: 'success',
                title: 'Kaydedildi',
                text: 'Fatura başarıyla oluşturuldu.',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // Modalı Kapat
        const modalEl = document.getElementById('evrakModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if(modalInstance) modalInstance.hide();

    } catch (error) {
        console.error("Kayıt Hatası:", error);
        Swal.fire({
            icon: 'error',
            title: 'Hata Oluştu',
            text: error.message || "Bilinmeyen bir hata oluştu."
        });
    } finally {
        // Butonu tekrar aktif et
        btn.disabled = false;
        btn.innerText = orjText;
    }
};

    // Basit işlemler (Nakit vb.) için eski düzenleme penceresi
    async function basitIslemDuzenle(id, veri) {
         const { value: formValues } = await Swal.fire({
                title: 'Kaydı Düzenle',
                html: `
                    <label class="small fw-bold d-block text-start text-muted">Tutar (TL)</label>
                    <input id="edit-amt" class="form-control mb-3 fw-bold" type="number" value="${veri.amount}">
                    <label class="small fw-bold d-block text-start text-muted">Açıklama</label>
                    <input id="edit-desc" class="form-control" type="text" value="${veri.description}">
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Güncelle',
                preConfirm: () => {
                    return {
                        amt: document.getElementById('edit-amt').value,
                        desc: document.getElementById('edit-desc').value
                    }
                }
            });

            if (formValues) {
                await updateDoc(doc(db, "transactions", id), {
                    amount: Number(formValues.amt),
                    description: formValues.desc
                });
                Swal.fire({ icon: 'success', title: 'Güncellendi', timer: 1000, showConfirmButton: false });
            }
    }
    // --- STOK YÖNETİMİ DEĞİŞKENLERİ ---
    let allProducts = [];

    // --- SAYFA YÜKLENİNCE STOKLARI DİNLE ---
    function stoklariDinle() {
        // Sadece kendi kooperatifinin ürünlerini getir
        const q = query(collection(db, "products"), where("coopId", "==", currentCoopId));
        
        onSnapshot(q, (snapshot) => {
            allProducts = [];
            const tbody = document.getElementById("stockTableBody");
            if(tbody) tbody.innerHTML = "";

            snapshot.forEach(doc => {
                let p = doc.data();
                p.id = doc.id;
                allProducts.push(p);

                // Tabloya Ekle
                // Stok azaldıysa (Örn: 10'un altı) kırmızı yakalım
                const stokDurumu = p.stock < 10 ? 'text-danger fw-bold' : 'text-dark';
                const row = `
                    <tr>
                        <td><div class="fw-bold">${p.name}</div></td>
                        <td><span class="badge bg-light text-secondary border">${p.category}</span></td>
                        <td class="text-center ${stokDurumu} fs-5">${p.stock} <small class="fs-6 text-muted">${p.unit}</small></td>
                        <td class="text-end fw-bold">${p.sellPrice} ₺</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-light border" onclick="urunDuzenle('${p.id}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn btn-sm btn-light border text-danger" onclick="urunSil('${p.id}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                if(tbody) tbody.innerHTML += row;
            });
        });
    }

    // Bu fonksiyonu "onAuthStateChanged" içinde, "sirketBilgileriniDinle"nin altına ekle:
    // stoklariDinle();  <-- Bunu unutma!

    // --- ÜRÜN EKLEME / GÜNCELLEME ---
    window.yeniUrunModalAc = function() {
        document.getElementById("productForm").reset();
        document.getElementById("prodId").value = "";
        new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    window.stokDegis = function(miktar) {
        const inp = document.getElementById("prodStock");
        let val = Number(inp.value) || 0;
        val += miktar;
        if(val < 0) val = 0;
        inp.value = val;
    }
// --- ÜRÜN KAYDETME (KOD DAHİL) ---
    document.getElementById("productForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("prodId").value;
        const data = {
            coopId: currentCoopId,
            code: document.getElementById("prodCode").value || "", // YENİ: Kod eklendi
            name: document.getElementById("prodName").value,
            category: document.getElementById("prodCat").value,
            unit: document.getElementById("prodUnit").value,
            buyPrice: Number(document.getElementById("prodBuy").value),
            sellPrice: Number(document.getElementById("prodSell").value),
            stock: Number(document.getElementById("prodStock").value)
        };

        try {
            if(id) {
                await updateDoc(doc(db, "products", id), data);
                Swal.fire({icon:'success', title:'Güncellendi', timer:1000, showConfirmButton:false});
            } else {
                await addDoc(collection(db, "products"), data);
                Swal.fire({icon:'success', title:'Ürün Eklendi', timer:1000, showConfirmButton:false});
            }
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        } catch (error) {
            console.error(error);
        }
    });

    // --- ÜRÜN DÜZENLEME (KODU GETİRİR) ---
    window.urunDuzenle = function(id) {
        const p = allProducts.find(x => x.id === id);
        if(!p) return;
        document.getElementById("prodId").value = p.id;
        document.getElementById("prodCode").value = p.code || ""; // YENİ: Kodu kutuya yaz
        document.getElementById("prodName").value = p.name;
        document.getElementById("prodCat").value = p.category;
        document.getElementById("prodUnit").value = p.unit;
        document.getElementById("prodBuy").value = p.buyPrice;
        document.getElementById("prodSell").value = p.sellPrice;
        document.getElementById("prodStock").value = p.stock;
        new bootstrap.Modal(document.getElementById('productModal')).show();
    }
    
    window.urunSil = async function(id) {
        if((await Swal.fire({title:'Silinsin mi?', icon:'warning', showCancelButton:true})).isConfirmed) {
            await deleteDoc(doc(db, "products", id));
        }
    }
    // --- SÜT LİSTESİNİ ÇEKME FONKSİYONU ---
    window.sutListesiniGetir = function() {
        if(!currentCoopId) return;

        // Son 50 kaydı getir (Tarihe göre tersten sırala)
        const q = query(
            collection(db, "milk_records"), 
            where("coopId", "==", currentCoopId),
            orderBy("date", "desc"),
            limit(50)
        );

        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById("milkTableBody");
            if(!tbody) return; 
            
            tbody.innerHTML = "";

            if(snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Henüz süt girişi yapılmamış.</td></tr>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const dateObj = data.date?.toDate();
                
                const tarih = dateObj ? dateObj.toLocaleDateString('tr-TR') : '-';
                const saat = dateObj ? dateObj.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '';

                let donemBadge = data.period === 'sabah' 
                    ? '<span class="badge bg-warning text-dark"><i class="fa-regular fa-sun me-1"></i>Sabah</span>'
                    : '<span class="badge bg-primary"><i class="fa-regular fa-moon me-1"></i>Akşam</span>';

                let durum = data.isProcessed 
                    ? '<span class="badge bg-success"><i class="fa-solid fa-check me-1"></i>Hesaplandı</span>'
                    : '<span class="badge bg-light text-secondary border">Bekliyor</span>';

                const tr = `
                    <tr>
                        <td>
                            <div class="fw-bold text-dark">${tarih}</div>
                            <small class="text-muted">${saat}</small>
                        </td>
                        <td><div class="fw-bold text-dark">${data.memberName}</div></td>
                        <td class="text-muted small"><i class="fa-solid fa-truck-fast me-1"></i>Driver</td>
                        <td class="text-center">${donemBadge}</td>
                        <td class="text-center"><span class="fs-5 fw-bold text-dark">${data.liters}</span> <small class="text-muted">Lt</small></td>
                        <td class="text-end">${durum}</td>
                        <td class="text-end">
                            ${!data.isProcessed ? `<button class="btn btn-sm btn-light text-danger border" onclick="sutKaydiSil('${doc.id}')"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        });
    }

   window.sutKaydiSil = async function(id) {
         if((await Swal.fire({title:'Silinsin mi?', text:'Bu süt kaydı silinecek.', icon:'warning', showCancelButton:true})).isConfirmed) {
            await deleteDoc(doc(db, "milk_records", id));
            Swal.fire({toast:true, position:'top-end', icon:'success', title:'Silindi', timer:1000, showConfirmButton:false});
        }
    }
</script>
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Ürün Kartı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
    <form id="productForm">
        <input type="hidden" id="prodId">
        
        <div class="row g-2 mb-3">
            <div class="col-4">
                <label class="form-label small fw-bold">Ürün Kodu</label>
                <input type="text" class="form-control" id="prodCode" placeholder="Örn: YEM01">
            </div>
            <div class="col-8">
                <label class="form-label small fw-bold">Ürün Adı</label>
                <input type="text" class="form-control" id="prodName" placeholder="Örn: 21 Protein Süt Yemi" required>
            </div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-6">
                <label class="form-label small fw-bold">Kategori</label>
                <select class="form-select" id="prodCat">
                    <option>Yem</option>
                    <option>Un</option>
                    <option>Kepek</option>
                    <option>Gübre</option>
                    <option>Akaryakıt</option>
                    <option>Diğer</option>
                </select>
            </div>
            <div class="col-6">
                <label class="form-label small fw-bold">Birim</label>
                <select class="form-select" id="prodUnit">
                    <option>Adet</option>
                    <option>Adet (Çuval)</option>
                    <option>Kg</option>
                    <option>Ton</option>
                    <option>Litre</option>
                    <option>Çuval</option>
                    <option>Koli</option>
                    <option>Paket</option>
                    <option>Metre</option>
                </select>
            </div>
        </div>
        <div class="row g-2 mb-3">
            <div class="col-6">
                <label class="form-label small fw-bold">Alış Fiyatı</label>
                <input type="number" class="form-control" id="prodBuy" placeholder="0.00">
            </div>
            <div class="col-6">
                <label class="form-label small fw-bold">Satış Fiyatı</label>
                <input type="number" class="form-control" id="prodSell" placeholder="0.00">
            </div>
        </div>
        <div class="mb-3 bg-light p-3 rounded border">
            <label class="form-label small fw-bold text-primary">Stok Girişi (Adet/Kg)</label>
            <div class="input-group">
                <button class="btn btn-outline-secondary" type="button" onclick="stokDegis(-1)"><i class="fa-solid fa-minus"></i></button>
                <input type="number" class="form-control text-center fw-bold" id="prodStock" value="0">
                <button class="btn btn-outline-secondary" type="button" onclick="stokDegis(1)"><i class="fa-solid fa-plus"></i></button>
            </div>
            <small class="text-muted">* Yeni mal geldiğinde burayı artırın.</small>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 fw-bold">KAYDET</button>
    </form>
</div>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="evrakModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable"> <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
               <h5 class="modal-title fw-bold text-primary" id="modalBaslik"><i class="fa-solid fa-file-invoice me-2"></i>Yeni Evrak Girişi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-3">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">İşlem Türü</label>
                                <select class="form-select" id="evrakTuru">
                                    <option value="satis">Satış (Borçlandır)</option>
                                    <option value="iade">İade Al (Alacaklandır)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">Tarih</label>
                                <input type="date" class="form-control" id="evrakTarih">
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">Belge No (Opsiyonel)</label>
                                <input type="text" class="form-control" id="evrakBelgeNo" placeholder="Otomatik">
                            </div>
                             <div class="col-md-3">
                                <label class="small fw-bold text-muted">Genel Açıklama</label>
                                <input type="text" class="form-control" id="evrakAciklama" placeholder="Örn: Yem Faturası">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                           <table class="table table-bordered mb-0 small" id="faturaTablosu">
    <thead class="table-light">
    <tr>
        <th style="width: 12%">Ürün Kodu</th> 
        <th style="width: 22%">Ürün / Hizmet Adı</th> 
        <th style="width: 8%">Miktar</th> 
        <th style="width: 13%">Birim</th> <th style="width: 12%">Birim Fiyat</th> 
        <th style="width: 8%">KDV %</th>
        <th style="width: 10%">KDV Tutarı</th>
        <th style="width: 15%">Toplam</th>
        <th style="width: 5%">Sil</th>
    </tr>
</thead>
    <tbody id="faturaSatirlari">
    </tbody>
    </table>
                                <tbody id="faturaSatirlari">
                                    </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="7">
                                            <button class="btn btn-sm btn-light border text-primary fw-bold w-100" onclick="satirEkle()">
                                                <i class="fa-solid fa-plus me-1"></i> Yeni Satır Ekle
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white">
    <div class="row justify-content-end">
        <div class="col-md-6 col-lg-4">
            <table class="table table-sm table-borderless text-end mb-0" style="font-size: 0.9rem;">
                <tr>
                    <td class="text-secondary">Ara Toplam (KDV Hariç):</td>
                    <td class="fw-bold text-dark" id="lblAraToplam">0,00 ₺</td>
                </tr>
                <tr>
                    <td class="text-secondary">Toplam KDV:</td>
                    <td class="fw-bold text-danger" id="lblKdvToplam">0,00 ₺</td>
                </tr>
                <tr class="border-top">
                    <td class="fw-bold text-dark fs-5 align-middle">GENEL TOPLAM:</td>
                    <td class="fw-bold text-dark fs-4" id="lblGenelToplam">0,00 ₺</td>
                </tr>
            </table>
        </div>
    </div>
</div>

            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary px-4 fw-bold" id="evrakKaydetBtn" onclick="evrakiKaydet()">KAYDET</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="detayModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
            
            <div class="modal-header modal-header-dynamic">
                <div>
                    <h5 class="modal-title fw-bold mb-1" id="detayBaslik">Fatura Detayı</h5>
                    <div class="opacity-75 small">
                        <i class="fa-regular fa-clock me-1"></i> <span id="detayTarihNo">...</span>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0 bg-white">
                <div class="table-responsive">
                    <table class="table table-invoice mb-0 w-100">
                        <thead>
                            <tr>
                                <th class="ps-4">Ürün / Hizmet</th>
                                <th class="text-center">Miktar</th>
                                <th class="text-end">Birim Fiyat</th>
                                <th class="text-center">KDV</th>
                                <th class="text-end pe-4">Toplam</th>
                            </tr>
                        </thead>
                        <tbody id="detayIcerik">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer bg-light border-0 d-block p-4">
                <div class="row">
                    <div class="col-md-7 mb-3 mb-md-0">
                        <div class="note-box shadow-sm">
                            <div class="fw-bold mb-1"><i class="fa-solid fa-circle-info me-1"></i> Açıklama</div>
                            <div id="detayAciklama" style="line-height: 1.4;">-</div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="summary-box">
                            <div class="total-row">
                                <span>Ara Toplam</span>
                                <span class="fw-bold text-dark" id="ozetAraToplam">0,00 ₺</span>
                            </div>
                            <div class="total-row">
                                <span>KDV Toplam</span>
                                <span class="fw-bold text-danger" id="ozetKdv">0,00 ₺</span>
                            </div>
                            
                            <div class="total-final">
                                <span class="text-uppercase fw-bold text-secondary small">Genel Toplam</span>
                                <span class="big-total" id="ozetGenelToplam">0,00 ₺</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="sutHesaplaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-calculator me-2"></i>Dönemsel Süt Hesapla</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small">
                    <i class="fa-solid fa-info-circle me-1"></i> 
                    Seçilen tarih aralığındaki <b>işlenmemiş</b> süt kayıtlarını toplar ve üyelerin cari hesabına "Alacak" olarak ekler.
                </div>

                <form id="sutHesapForm">
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="fw-bold small text-muted">Başlangıç Tarihi</label>
                            <input type="date" class="form-control" id="calcStartDate" required>
                        </div>
                        <div class="col-6">
                            <label class="fw-bold small text-muted">Bitiş Tarihi</label>
                            <input type="date" class="form-control" id="calcEndDate" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Litre Fiyatı (TL)</label>
                        <div class="input-group">
                            <input type="number" class="form-control fs-5 fw-bold text-primary" id="calcPrice" placeholder="0.00" step="0.01" required>
                            <span class="input-group-text">₺</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Açıklama (Otomatik Oluşur)</label>
                        <input type="text" class="form-control text-muted" id="calcDesc" placeholder="Örn: 01-07 Kasım Süt Bedeli" readonly>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-dark fw-bold py-2">HESAPLA VE CARİYE İŞLE</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>